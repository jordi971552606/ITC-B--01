<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITC-BT-10: Previsi√≥n de cargas</title>
    <style>
        /* === ESTILOS CSS === */
        /* Definici√≥n de la apariencia visual de todos los elementos de la p√°gina */

        /* --- Estilos Generales --- */
        /* Configuraci√≥n b√°sica del cuerpo de la p√°gina */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; /* Fuentes del sistema para mejor legibilidad */
            line-height: 1.6; /* Espaciado entre l√≠neas para facilitar la lectura */
            margin: 0; /* Eliminar m√°rgenes por defecto del navegador */
            padding: 0; /* Eliminar padding por defecto del navegador */
            background-color: #f4f7f9; /* Color de fondo azul claro */
            color: #333; /* Color de texto principal */
            transition: background-color 0.3s; /* Transici√≥n suave para cambios de color de fondo */
        }
        /* Contenedor principal para centrar el contenido */
        .container {
            max-width: 900px; /* Ancho m√°ximo del contenido */
            margin: auto; /* Centrado autom√°tico horizontal */
            overflow: hidden; /* Ocultar desbordamiento del contenido */
            padding: 0 20px; /* Espaciado interno lateral */
        }

        /* Cabecera de la p√°gina */
        header {
            background: #005a9c; /* Color de fondo azul corporativo */
            color: #fff; /* Texto en blanco */
            padding: 1.2rem 0; /* Espaciado interno vertical */
            text-align: center; /* Centrar texto */
            border-bottom: 4px solid #004a8c; /* Borde inferior azul m√°s oscuro */
        }
        header h1 {
            margin: 0; /* Eliminar m√°rgenes del t√≠tulo */
            font-size: 2em; /* Tama√±o de fuente grande para el t√≠tulo */
        }

        /* T√≠tulos de segundo y tercer nivel */
        h2, h3 {
            color: #005a9c; /* Color azul corporativo para los t√≠tulos */
        }
        /* Estilo b√°sico para botones principales */
        .btn {
            display: inline-block; /* Comportamiento de elemento en l√≠nea con propiedades de bloque */
            background: #005a9c; /* Color de fondo azul corporativo */
            color: #fff; /* Texto en blanco */
            padding: 12px 25px; /* Espaciado interno para hacer el bot√≥n m√°s c√≥modo de usar */
            border: none; /* Sin borde */
            border-radius: 5px; /* Esquinas redondeadas */
            cursor: pointer; /* Cambiar cursor a puntero al pasar por encima */
            text-decoration: none; /* Sin subrayado de texto */
            text-align: center; /* Centrar texto del bot√≥n */
            font-size: 1em; /* Tama√±o de fuente est√°ndar */
            transition: background-color 0.3s, transform 0.2s; /* Transiciones suaves para efectos hover */
        }
        /* Efecto hover para botones - cambio de color y elevaci√≥n */
        .btn:hover {
            background: #004a8c; /* Color m√°s oscuro al pasar el rat√≥n */
            transform: translateY(-2px); /* Efecto de elevaci√≥n sutil */
        }
        /* Variante de bot√≥n secundario con color gris */
        .btn-secondary {
            background-color: #6c757d; /* Color gris */
        }
        .btn-secondary:hover {
            background-color: #5a6268; /* Gris m√°s oscuro en hover */
        }
        /* Clase para ocultar elementos */
        .hidden {
            display: none; /* Hace invisible el elemento */
        }

        /* --- Vistas Espec√≠ficas --- */
        /* Contenedor principal para cada vista de la aplicaci√≥n */
        .view-box {
            background: #fff; /* Fondo blanco */
            padding: 2.5rem; /* Espaciado interno generoso */
            margin-top: 2rem; /* Margen superior */
            border-radius: 8px; /* Esquinas redondeadas */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Sombra sutil para profundidad */
        }

        /* Estilos para campos de entrada de datos */
        input[type="text"], input[type="password"], input[type="number"], select {
            width: 100%; /* Ancho completo del contenedor */
            padding: 12px; /* Espaciado interno para comodidad */
            margin-bottom: 15px; /* Margen inferior entre campos */
            border-radius: 5px; /* Esquinas redondeadas */
            border: 1px solid #ddd; /* Borde gris claro */
            box-sizing: border-box; /* Incluir padding y border en el ancho total */
            font-size: 1em; /* Tama√±o de fuente est√°ndar */
            background-color: white; /* Fondo blanco */
        }
        
        /* Estilo espec√≠fico para listas desplegables */
        select {
            cursor: pointer; /* Cambiar cursor para indicar interactividad */
        }
        
        /* Efecto focus para listas desplegables */
        select:focus {
            border-color: #005a9c; /* Cambiar color del borde al enfocar */
            outline: none; /* Eliminar outline por defecto del navegador */
            box-shadow: 0 0 5px rgba(0, 90, 156, 0.3); /* Sombra azul sutil al enfocar */
        }
        /* Dise√±o de cuadr√≠cula para los bloques de ejercicios */
        .exercise-blocks {
            display: grid; /* Usar CSS Grid para el layout */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Columnas que se adaptan autom√°ticamente */
            gap: 20px; /* Espacio entre elementos de la cuadr√≠cula */
            margin-top: 20px; /* Margen superior */
        }

        /* Estilo para cada bloque individual de ejercicio */
        .block {
            background: #f8f9fa; /* Fondo gris muy claro */
            padding: 20px; /* Espaciado interno */
            border-radius: 8px; /* Esquinas redondeadas */
            text-align: center; /* Centrar contenido */
            border: 1px solid #e9ecef; /* Borde gris claro */
            transition: box-shadow 0.3s, transform 0.3s; /* Transiciones suaves para efectos hover */
        }
        /* Efecto hover para bloques - elevaci√≥n y sombra */
        .block:hover {
            transform: translateY(-5px); /* Elevar el bloque al pasar el rat√≥n */
            box-shadow: 0 6px 20px rgba(0,0,0,0.1); /* Sombra m√°s pronunciada */
        }
        .block h3 {
            margin-top: 0; /* Eliminar margen superior del t√≠tulo */
        }

        /* --- Estilos para Ejemplos y Ejercicios --- */
        /* Contenedor para cada ejercicio individual */
        .exercise-item {
            background-color: #fff; /* Fondo blanco */
            border: 1px solid #e0e0e0; /* Borde gris claro */
            border-radius: 8px; /* Esquinas redondeadas */
            padding: 20px; /* Espaciado interno */
            margin-bottom: 20px; /* Margen inferior entre ejercicios */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Sombra muy sutil */
        }
        .exercise-item h3 {
            margin-top: 0; /* Eliminar margen superior del t√≠tulo */
            border-bottom: 2px solid #005a9c; /* L√≠nea inferior azul */
            padding-bottom: 10px; /* Espaciado antes de la l√≠nea */
        }

        /* Estilo para mostrar el enunciado del problema */
        .enunciado {
            white-space: pre-wrap; /* Mantener los saltos de l√≠nea del enunciado */
            background-color: #e9ecef; /* Fondo gris claro */
            padding: 15px; /* Espaciado interno */
            border-radius: 5px; /* Esquinas redondeadas */
            font-family: "Courier New", Courier, monospace; /* Fuente monoespaciada para mejor lectura */
            margin-bottom: 15px; /* Margen inferior */
        }

        /* Estilo para mostrar la soluci√≥n del problema */
        .solucion {
            white-space: pre-wrap; /* Mantener formato de texto */
            background-color: #f0fff0; /* Fondo verde muy claro */
            border-left: 4px solid #28a745; /* Borde izquierdo verde */
            padding: 15px; /* Espaciado interno */
            border-radius: 5px; /* Esquinas redondeadas */
            margin-top: 10px; /* Margen superior */
        }

        /* Modificar el fondo de soluci√≥n cuando la respuesta es incorrecta */
        .incorrect-feedback .solucion {
            background-color: #fff3f3; /* Fondo rojo muy claro */
            border-left-color: #dc3545; /* Borde izquierdo rojo */
        }

        /* Estilo para respuestas correctas */
        .correct-answer {
            color: #28a745; /* Texto verde */
            font-weight: bold; /* Texto en negrita */
        }

        /* Estilo para respuestas incorrectas */
        .incorrect-answer {
            color: #dc3545; /* Texto rojo */
            font-weight: bold; /* Texto en negrita */
            text-decoration: line-through; /* Texto tachado */
        }
        
        /* === Estilos para tablas de calibres CGP (Cuadro General de Protecci√≥n) === */
        .cgp-info {
            background-color: #f8f9fa; /* Fondo gris claro */
            border: 1px solid #dee2e6; /* Borde gris */
            border-radius: 8px; /* Esquinas redondeadas */
            padding: 15px; /* Espaciado interno */
            margin: 20px 0; /* M√°rgenes superior e inferior */
        }
        
        /* Tabla de calibres CGP */
        .cgp-table {
            width: 100%; /* Ancho completo */
            border-collapse: collapse; /* Bordes unidos sin espacios */
            margin-top: 10px; /* Margen superior */
        }
        
        /* Celdas de la tabla CGP */
        .cgp-table th, .cgp-table td {
            border: 1px solid #dee2e6; /* Borde gris para todas las celdas */
            padding: 8px 12px; /* Espaciado interno de las celdas */
            text-align: center; /* Centrar contenido de las celdas */
        }
        
        /* Encabezados de la tabla CGP */
        .cgp-table th {
            background-color: #005a9c; /* Fondo azul corporativo */
            color: white; /* Texto blanco */
            font-weight: bold; /* Texto en negrita */
        }
        
        /* Filas pares de la tabla con fondo alternativo */
        .cgp-table tr:nth-child(even) {
            background-color: #f8f9fa; /* Fondo gris muy claro para filas pares */
        }
        
        /* Fila seleccionada en la tabla CGP */
        .cgp-selected {
            background-color: #d4edda !important; /* Fondo verde claro, importante para sobrescribir otros estilos */
            font-weight: bold; /* Texto en negrita */
        }
        
        /* --- Estilos para Ejercicios Guiados --- */
        /* Contenedor principal del ejercicio guiado */
        .guided-exercise {
            background-color: #f8f9fa; /* Fondo gris claro */
            border: 2px solid #005a9c; /* Borde azul corporativo */
            border-radius: 10px; /* Esquinas m√°s redondeadas que otros elementos */
            padding: 20px; /* Espaciado interno */
            margin: 20px 0; /* M√°rgenes superior e inferior */
        }
        
        /* Cada paso individual del ejercicio guiado */
        .guided-step {
            background-color: white; /* Fondo blanco */
            border: 1px solid #dee2e6; /* Borde gris claro */
            border-radius: 5px; /* Esquinas redondeadas */
            padding: 15px; /* Espaciado interno */
            margin: 15px 0; /* M√°rgenes superior e inferior */
        }
        
        /* Pregunta de cada paso */
        .step-question {
            font-weight: bold; /* Texto en negrita */
            color: #005a9c; /* Color azul corporativo */
            margin-bottom: 10px; /* Margen inferior */
        }
        
        /* Contenedor para entrada de datos en cada paso */
        .step-input {
            display: flex; /* Dise√±o flexbox */
            align-items: center; /* Alinear elementos verticalmente al centro */
            gap: 10px; /* Espacio entre elementos */
            margin: 10px 0; /* M√°rgenes superior e inferior */
        }
        
        /* Campo de entrada en cada paso */
        .step-input input {
            padding: 8px; /* Espaciado interno */
            border: 1px solid #ccc; /* Borde gris */
            border-radius: 4px; /* Esquinas redondeadas */
            width: 150px; /* Ancho fijo */
        }
        
        /* Retroalimentaci√≥n general para cada paso */
        .step-feedback {
            margin-top: 10px; /* Margen superior */
            padding: 10px; /* Espaciado interno */
            border-radius: 5px; /* Esquinas redondeadas */
        }
        
        /* Retroalimentaci√≥n para respuestas correctas */
        .step-success {
            background-color: #d4edda; /* Fondo verde claro */
            color: #155724; /* Texto verde oscuro */
            border: 1px solid #c3e6cb; /* Borde verde claro */
        }
        
        /* Retroalimentaci√≥n para respuestas incorrectas */
        .step-error {
            background-color: #f8d7da; /* Fondo rojo claro */
            color: #721c24; /* Texto rojo oscuro */
            border: 1px solid #f5c6cb; /* Borde rojo claro */
        }
        
        /* Retroalimentaci√≥n para pistas o sugerencias */
        .step-hint {
            background-color: #fff3cd; /* Fondo amarillo claro */
            color: #856404; /* Texto amarillo oscuro */
            border: 1px solid #ffeaa7; /* Borde amarillo claro */
        }
        
        /* Pasos completados (apariencia atenuada) */
        .guided-step.completed {
            opacity: 0.8; /* Reducir opacidad */
            background-color: #f8f9fa; /* Fondo gris claro */
            border-color: #e9ecef; /* Borde gris m√°s claro */
        }
        
        /* Preguntas de pasos completados */
        .guided-step.completed .step-question {
            color: #6c757d; /* Color gris para indicar que est√° completado */
        }
        
        /* Bot√≥n espec√≠fico para ejercicios guiados */
        .btn-guided {
            background: #28a745; /* Fondo verde */
        }
        
        .btn-guided:hover {
            background: #218838; /* Verde m√°s oscuro en hover */
        }
        
        /* === ESTILOS PARA FUNCIONALIDADES DE GRABACI√ìN Y ENV√çO === */
        
        /* Bot√≥n de grabaci√≥n */
        .btn-recording {
            background-color: #28a745; /* Verde para indicar grabaci√≥n */
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-recording:hover {
            background-color: #218838; /* Verde m√°s oscuro en hover */
        }
        
        /* Bot√≥n de env√≠o al profesor */
        .btn-submit {
            background-color: #dc3545; /* Rojo para destacar la importancia */
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-submit:hover {
            background-color: #c82333; /* Rojo m√°s oscuro en hover */
        }
        
        /* Bot√≥n deshabilitado despu√©s del env√≠o */
        .btn-submitted {
            background-color: #6c757d; /* Gris para indicar que ya se envi√≥ */
            cursor: not-allowed;
        }
        
        /* Estilos para notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        /* Animaci√≥n para las notificaciones */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <header>
        <!-- Cabecera principal de la aplicaci√≥n -->
        <h1>ITC-BT-10: Previsi√≥n de cargas</h1>
    </header>

    <div class="container">
        <!-- Contenedor principal que centra todo el contenido -->

        <!-- === VISTA DE INICIO DE SESI√ìN === -->
        <!-- Primera vista que se muestra para que el alumno seleccione su nombre -->
        <div id="loginView" class="view-box">
            <h2>Acceso para Alumnos</h2>
            <form id="loginForm">
                <label for="studentSelect">Selecciona tu nombre:</label>
                <!-- Lista desplegable con todos los nombres de los alumnos -->
                <select id="studentSelect" name="studentSelect" required>
                    <option value="">-- Selecciona tu nombre --</option>
                    <!-- Lista completa de alumnos del curso -->
                    <option value="Dariel Aguasvivas de Jesus">Dariel Aguasvivas de Jesus</option>
                    <option value="Alfonso Caballero Montiel">Alfonso Caballero Montiel</option>
                    <option value="Andr√©s Caballero Montiel">Andr√©s Caballero Montiel</option>
                    <option value="Mohamed El miri">Mohamed El miri</option>
                    <option value="Miguel Alejandro Gonzalez Moreno">Miguel Alejandro Gonzalez Moreno</option>
                    <option value="Marc Jaime Darder">Marc Jaime Darder</option>
                    <option value="Mohamed Kouroma">Mohamed Kouroma</option>
                    <option value="Jaume Lop√©z Llull">Jaume Lop√©z Llull</option>
                    <option value="Jeremy Josep Olivares llanos">Jeremy Josep Olivares llanos</option>
                    <option value="Joan Miquel Oliver Vidal">Joan Miquel Oliver Vidal</option>
                    <option value="Wasim Ouchen Benali">Wasim Ouchen Benali</option>
                    <option value="Yamin Ouchen Benali">Yamin Ouchen Benali</option>
                </select>
                <button type="submit" class="btn">Entrar</button>
            </form>
        </div>

        <!-- === VISTA DE SELECCI√ìN DE BLOQUES === -->
        <!-- Segunda vista que muestra los bloques de ejercicios disponibles -->
        <div id="blocksView" class="view-box hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <!-- Mensaje de bienvenida personalizado con el nombre del alumno -->
                <h2 id="welcomeMessage">Bienvenido</h2>
                <!-- Bot√≥n para cerrar sesi√≥n -->
                <button id="logoutBtn" class="btn btn-secondary">Cerrar Sesi√≥n</button>
            </div>
            
            <!-- Cuadr√≠cula con los tres bloques de ejercicios (ocultos para el examen) -->
            <div class="exercise-blocks" style="display: none;">
                <!-- Bloque 1: Ejercicios simples -->
                <div class="block">
                    <h3>Bloque 1</h3>
                    <p>Previsi√≥n de cargas simples (viviendas, locales, etc.).</p>
                    <button class="btn" onclick="startExercises(1)">Comenzar</button>
                </div>
                <!-- Bloque 2: Edificios sin LGA -->
                <div class="block">
                    <h3>Bloque 2</h3>
                    <p>C√°lculo de la carga total para edificios completos.</p>
                    <button class="btn" onclick="startExercises(2)">Comenzar</button>
                </div>
                <!-- Bloque 3: Edificios con LGA -->
                <div class="block">
                    <h3>Bloque 3</h3>
                    <p>Edificios completos incluyendo la L√≠nea General de Alimentaci√≥n (LGA).</p>
                    <button class="btn" onclick="startExercises(3)">Comenzar</button>
                </div>
            </div>
            
            <!-- Bot√≥n de Examen -->
            <div class="exam-section" style="text-align: center; margin-top: 30px;">
                <div class="block" style="max-width: 500px; margin: 0 auto;">
                    <h3>Examen</h3>
                    <p>Resuelve 2 ejercicios complejos de edificios con LGA para demostrar tus conocimientos.</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn" onclick="startRecording()" style="background-color: #28a745; color: white; font-size: 1.1em; padding: 12px 24px;">üé• Iniciar Grabaci√≥n</button>
                        <button id="examStartBtn" class="btn" onclick="startExam()" style="font-size: 1.2em; padding: 15px 30px; display: none;">Comenzar Examen</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VISTA DE EJERCICIOS === -->
        <!-- Tercera vista que muestra los ejercicios generados din√°micamente -->
        <div id="exercisesView" class="hidden">
            <div class="view-box">
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                     <!-- Bot√≥n para volver a la selecci√≥n de bloques -->
                     <button id="backToBlocksBtn" class="btn btn-secondary">‚Üê Volver a los bloques</button>
                     <!-- Bot√≥n para cerrar sesi√≥n desde la vista de ejercicios -->
                     <button id="logoutBtnExercises" class="btn btn-secondary">Cerrar Sesi√≥n</button>
                 </div>
                 
                 <!-- T√≠tulo din√°mico que cambia seg√∫n el tipo de contenido mostrado -->
                 <h2 id="exerciseTitle"></h2>
                 
                 <!-- √Årea donde se muestran los ejercicios generados din√°micamente -->
                 <div id="contentArea"></div>
                 
                 <!-- √Årea para botones de control (corregir, navegar, etc.) -->
                 <div id="controlsArea" class="hidden" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div> <!-- Fin del contenedor principal -->

<script>
// ================================================================
// === C√ìDIGO JAVASCRIPT PRINCIPAL ===
// ================================================================

// ================================================================
// SECCI√ìN 1: CONFIGURACI√ìN Y ESTADO DE LA APLICACI√ìN
// ================================================================

/**
 * Estado global de la aplicaci√≥n
 * Mantiene la informaci√≥n sobre el usuario actual, el bloque seleccionado
 * y los ejercicios generados para evitar duplicados
 */
const appState = {
    currentBlock: null,        // Bloque actual seleccionado (1, 2 o 3)
    currentStudent: null,      // Nombre del estudiante actual
    generatedExercises: []     // Array de ejercicios ya generados para evitar repeticiones
};

// ================================================================
// SECCI√ìN 1.1: CONFIGURACI√ìN PARA GRABACI√ìN Y ENV√çO AL PROFESOR
// ================================================================

/**
 * Configuraci√≥n para env√≠o de resultados del examen al profesor
 * usando Google Sheets como base de datos
 */
const GOOGLE_SHEETS_CONFIG = {
    // URL del Google Apps Script Web App (configurar despu√©s de crear el script)
    WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbwof6IZEGowgROMuQ_SYVZsh7hmSB9cxscUvzDCJF0QZNHYdXKBY8FrDtZ6OPO8Yc9x/exec',
    // ID de la hoja de c√°lculo de Google (configurar con el ID real)
    SPREADSHEET_ID: '1zF5aKiWE5vOud4gJgO9WDhmCpMC9JF9qvNsQMpMoOTI',
    // Habilitar/deshabilitar env√≠o a Google Sheets
    ENABLED: true,
    // Modo debug para mostrar informaci√≥n de depuraci√≥n
    DEBUG_MODE: true
};

/**
 * Contrase√±a para acceder al examen
 * Solo con esta contrase√±a se puede acceder al modo examen
 */
const examPassword = "13HiX6589HOIhjxcHnWp";

// ================================================================
// SECCI√ìN 2: REFERENCIAS DEL DOM
// ================================================================

/**
 * Referencias a los elementos principales del DOM
 * Se obtienen una vez al cargar la p√°gina para optimizar el rendimiento
 */
const loginView = document.getElementById('loginView');           // Vista de inicio de sesi√≥n
const blocksView = document.getElementById('blocksView');         // Vista de selecci√≥n de bloques
const exercisesView = document.getElementById('exercisesView');   // Vista de ejercicios
const welcomeMessage = document.getElementById('welcomeMessage'); // Mensaje de bienvenida
const exerciseTitle = document.getElementById('exerciseTitle');   // T√≠tulo de la secci√≥n de ejercicios
const contentArea = document.getElementById('contentArea');       // √Årea donde se muestran los ejercicios
const controlsArea = document.getElementById('controlsArea');     // √Årea de botones de control
const backToBlocksBtn = document.getElementById('backToBlocksBtn'); // Bot√≥n para volver a bloques

// ================================================================
// SECCI√ìN 3: EVENTOS Y MANEJADORES DE NAVEGACI√ìN
// ================================================================

/**
 * Manejador del formulario de inicio de sesi√≥n
 * Valida que se haya seleccionado un alumno y cambia a la vista de bloques
 */
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevenir el env√≠o normal del formulario
    const selectedStudent = document.getElementById('studentSelect').value;
    
    // Validar que se haya seleccionado un estudiante
    if (!selectedStudent) {
        alert('Por favor, selecciona tu nombre de la lista.');
        return;
    }
    
    // Guardar el estudiante actual y actualizar la interfaz
    appState.currentStudent = selectedStudent;
    welcomeMessage.textContent = `Bienvenido, ${selectedStudent}`;
    
    // Cambiar de vista: ocultar login y mostrar bloques
    loginView.classList.add('hidden');
    blocksView.classList.remove('hidden');
});

/**
 * Manejador del bot√≥n "Volver a los bloques"
 * Permite navegar desde la vista de ejercicios de vuelta a la selecci√≥n de bloques
 */
backToBlocksBtn.addEventListener('click', () => {
    exercisesView.classList.add('hidden');
    blocksView.classList.remove('hidden');
});

/**
 * Configuraci√≥n de los botones de cerrar sesi√≥n
 * Hay dos botones: uno en la vista de bloques y otro en la vista de ejercicios
 */
document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('logoutBtnExercises').addEventListener('click', logout);

/**
 * Funci√≥n para cerrar sesi√≥n
 * Intenta cerrar la ventana del navegador, y si no es posible, redirige a una p√°gina en blanco
 */
function logout() {
    // Intentar cerrar la p√°gina web
    window.close();
    
    // Si window.close() no funciona (por restricciones del navegador), 
    // redirigir a una p√°gina en blanco como alternativa
    if (!window.closed) {
        window.location.href = 'about:blank';
    }
}

/**
 * Funci√≥n para volver al men√∫ principal de bloques
 * Permite navegar desde cualquier vista de ejercicios de vuelta al men√∫ principal
 */
function backToBlocks() {
    exercisesView.classList.add('hidden');
    blocksView.classList.remove('hidden');
}

/**
 * Funci√≥n principal para iniciar los ejercicios de un bloque espec√≠fico
 * @param {number} blockNumber - N√∫mero del bloque (1, 2 o 3)
 */
function startExercises(blockNumber) {
    appState.currentBlock = blockNumber;
    
    // Cambiar de vista: ocultar bloques y mostrar ejercicios
    blocksView.classList.add('hidden');
    exercisesView.classList.remove('hidden');
    
    // Mostrar primero los ejemplos resueltos
    displayExamples();
}

/**
 * Funci√≥n para iniciar el examen con 2 ejercicios del bloque 3
 * El examen va directamente a los ejercicios sin mostrar ejemplos
 */
function startExam() {
    // Validar contrase√±a del examen antes de continuar
    if (!validateExamPassword()) {
        return; // Si la contrase√±a es incorrecta, no continuar
    }
    
    appState.currentBlock = 3; // Los ex√°menes siempre usan ejercicios del bloque 3
    
    // Cambiar de vista: ocultar bloques y mostrar ejercicios
    blocksView.classList.add('hidden');
    exercisesView.classList.remove('hidden');
    
    // Ir directamente a los ejercicios del examen (sin ejemplos)
    displayExamProblems();
}

/**
 * Funci√≥n para mostrar los 10 ejemplos resueltos del bloque seleccionado
 * Los ejemplos sirven como referencia para que los alumnos entiendan la metodolog√≠a
 */
function displayExamples() {
    // Actualizar el t√≠tulo de la secci√≥n
    exerciseTitle.textContent = `Bloque ${appState.currentBlock}: 10 Ejemplos Resueltos`;
    
    // Limpiar √°reas de contenido
    contentArea.innerHTML = '';
    controlsArea.innerHTML = '';

    // Generar y mostrar 10 ejemplos resueltos
    for (let i = 0; i < 10; i++) {
        const exercise = generateExercise(appState.currentBlock);
        
        // Crear HTML para cada ejemplo con enunciado y soluci√≥n completa
        const exampleHTML = `
            <div class="exercise-item">
                <h3>Ejemplo ${i + 1}</h3>
                <div class="enunciado">${exercise.enunciado}</div>
                <h4>Resoluci√≥n Paso a Paso:</h4>
                <div class="solucion">${exercise.solucion}</div>
                ${exercise.tablaCGP ? exercise.tablaCGP : ''}
            </div>
        `;
        contentArea.innerHTML += exampleHTML;
    }

    // Crear botones de navegaci√≥n
    // Bot√≥n para ir a ejercicios para resolver
    const practiceBtn = document.createElement('button');
    practiceBtn.className = 'btn';
    practiceBtn.textContent = 'Ir a la p√°gina de ejercicios';
    practiceBtn.onclick = displayPracticeProblems;
    
    // Bot√≥n para ejercicios guiados paso a paso
    const guidedBtn = document.createElement('button');
    guidedBtn.className = 'btn btn-guided';
    guidedBtn.textContent = 'Ejercicios Guiados';
    guidedBtn.onclick = startGuidedExercise;
    guidedBtn.style.marginLeft = '10px';
    
    // A√±adir botones al √°rea de controles
    controlsArea.appendChild(practiceBtn);
    controlsArea.appendChild(guidedBtn);
    controlsArea.classList.remove('hidden');
}

/**
 * Funci√≥n para mostrar ejercicios sin resolver para que el alumno practique
 * Genera 10 ejercicios nuevos donde el alumno debe introducir la respuesta
 */
function displayPracticeProblems() {
    // Determinar n√∫mero de ejercicios seg√∫n el bloque
    let numEjercicios;
    if (appState.currentBlock === 2) {
        numEjercicios = 5;
    } else if (appState.currentBlock === 3) {
        numEjercicios = 4;
    } else {
        numEjercicios = 10; // Bloque 1
    }
    
    // Actualizar t√≠tulo y limpiar √°reas
    exerciseTitle.textContent = `Bloque ${appState.currentBlock}: ${numEjercicios} Ejercicios para Resolver`;
    contentArea.innerHTML = '';
    controlsArea.innerHTML = '';
    appState.generatedExercises = []; // Reiniciar lista de ejercicios generados

    // Generar ejercicios seg√∫n el bloque
    for (let i = 0; i < numEjercicios; i++) {
        const exercise = generateExercise(appState.currentBlock);
        appState.generatedExercises.push(exercise); // Guardar para la correcci√≥n
        
        let problemHTML = `
            <div class="exercise-item" id="problem-${i}">
                <h3>Ejercicio ${i + 1}</h3>
                <div class="enunciado">${exercise.enunciado}</div>
        `;
        
        // Para el bloque 3, solicitar m√∫ltiples respuestas
        if (appState.currentBlock === 3) {
            problemHTML += `
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>Respuestas requeridas:</h4>
                    
                    <label for="pt-${i}"><b>1. Potencia Total del Edificio (PT) en W:</b></label>
                    <input type="number" id="pt-${i}" placeholder="Potencia total en Watts">
                    
                    <label for="intensidad-${i}"><b>2. Intensidad calculada en A:</b></label>
                    <input type="number" id="intensidad-${i}" step="0.01" placeholder="Intensidad en Amperios">
                    
                    <label for="fusible-${i}"><b>3. Fusible CGP seleccionado en A:</b></label>
                    <input type="number" id="fusible-${i}" placeholder="Fusible en Amperios">
                    
                    <label for="calibre-${i}"><b>4. Calibre CGP seleccionado en A:</b></label>
                    <input type="number" id="calibre-${i}" placeholder="Calibre en Amperios">
                    
                    <label for="seccion-lga-${i}"><b>5. Secci√≥n final de la LGA en mm¬≤:</b></label>
                    <input type="number" id="seccion-lga-${i}" placeholder="Secci√≥n LGA en mm¬≤">
                </div>
            `;
        } else {
            // Para bloques 1 y 2, solo la respuesta de potencia
            problemHTML += `
                <label for="answer-${i}"><b>Tu respuesta (en W):</b></label>
                <input type="number" id="answer-${i}" placeholder="Introduce el resultado num√©rico en Watts">
            `;
        }
        
        problemHTML += `
                <div id="feedback-${i}" class="feedback-area"></div>
            </div>
        `;
        
        contentArea.innerHTML += problemHTML;
    }

    // Crear bot√≥n para corregir todos los ejercicios
    const checkBtn = document.createElement('button');
    checkBtn.className = 'btn';
    checkBtn.textContent = 'Corregir Ejercicios';
    checkBtn.onclick = checkAnswers;
    controlsArea.appendChild(checkBtn);
}

/**
 * Funci√≥n espec√≠fica para mostrar los ejercicios del examen
 * Incluye 4 ejercicios del bloque 1 (0.5 pts c/u) y 2 ejercicios del bloque 3 (0.8 pts por apartado)
 * Puntuaci√≥n total: 4√ó0.5 + 2√ó5√ó0.8 = 2 + 8 = 10 puntos
 */
function displayExamProblems() {
    const numEjerciciosBloque1 = 4; // 4 ejercicios del bloque 1
    const numEjerciciosBloque3 = 2; // 2 ejercicios del bloque 3
    
    // Actualizar t√≠tulo y limpiar √°reas
    exerciseTitle.textContent = `Examen: Previsi√≥n de Cargas ITC-BT-10`;
    contentArea.innerHTML = '';
    controlsArea.innerHTML = '';
    appState.generatedExercises = []; // Reiniciar lista de ejercicios generados

    // Mostrar informaci√≥n de puntuaci√≥n
    contentArea.innerHTML += `
        <div style="background-color: #e7f3ff; border: 2px solid #005a9c; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #005a9c;">üìã Estructura del Examen</h3>
            <ul style="margin-bottom: 0;">
                <li><strong>Parte A:</strong> ${numEjerciciosBloque1} ejercicios de cargas simples (${numEjerciciosBloque1} √ó 0.5 = <strong>2 puntos</strong>)</li>
                <li><strong>Parte B:</strong> ${numEjerciciosBloque3} ejercicios de edificios con LGA (${numEjerciciosBloque3} √ó 5 apartados √ó 0.8 = <strong>8 puntos</strong>)</li>
                <li><strong>Total:</strong> 10 puntos</li>
            </ul>
        </div>
    `;

    // === PARTE A: Ejercicios del Bloque 1 ===
    contentArea.innerHTML += `<h2 style="color: #005a9c; border-bottom: 2px solid #005a9c; padding-bottom: 10px;">Parte A: Cargas Simples (0.5 pts cada uno)</h2>`;
    
    for (let i = 0; i < numEjerciciosBloque1; i++) {
        const exercise = generateExercise(1); // Bloque 1: cargas simples
        exercise.bloque = 1; // Marcar como bloque 1
        appState.generatedExercises.push(exercise);
        
        let problemHTML = `
            <div class="exercise-item" id="problem-${i}">
                <h3>Ejercicio A.${i + 1} <span style="color: #6c757d; font-size: 0.8em;">(0.5 pts)</span></h3>
                <div class="enunciado">${exercise.enunciado}</div>
                <label for="answer-${i}"><b>Tu respuesta (en W):</b></label>
                <input type="number" id="answer-${i}" placeholder="Introduce el resultado num√©rico en Watts">
                <div id="feedback-${i}" class="feedback-area"></div>
            </div>
        `;
        contentArea.innerHTML += problemHTML;
    }

    // === PARTE B: Ejercicios del Bloque 3 ===
    contentArea.innerHTML += `<h2 style="color: #005a9c; border-bottom: 2px solid #005a9c; padding-bottom: 10px; margin-top: 30px;">Parte B: Edificios con LGA (0.8 pts cada apartado)</h2>`;
    
    for (let i = 0; i < numEjerciciosBloque3; i++) {
        const globalIndex = numEjerciciosBloque1 + i; // √çndice global para los IDs
        const exercise = generateExercise(3); // Bloque 3: edificios con LGA
        exercise.bloque = 3; // Marcar como bloque 3
        appState.generatedExercises.push(exercise);
        
        let problemHTML = `
            <div class="exercise-item" id="problem-${globalIndex}">
                <h3>Ejercicio B.${i + 1} <span style="color: #6c757d; font-size: 0.8em;">(5 apartados √ó 0.8 = 4 pts)</span></h3>
                <div class="enunciado">${exercise.enunciado}</div>
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>Respuestas requeridas:</h4>
                    
                    <label for="pt-${globalIndex}"><b>1. Potencia Total del Edificio (PT) en W:</b> <span style="color: #6c757d;">(0.8 pts)</span></label>
                    <input type="number" id="pt-${globalIndex}" placeholder="Potencia total en Watts">
                    
                    <label for="intensidad-${globalIndex}"><b>2. Intensidad calculada en A:</b> <span style="color: #6c757d;">(0.8 pts)</span></label>
                    <input type="number" id="intensidad-${globalIndex}" step="0.01" placeholder="Intensidad en Amperios">
                    
                    <label for="fusible-${globalIndex}"><b>3. Fusible CGP seleccionado en A:</b> <span style="color: #6c757d;">(0.8 pts)</span></label>
                    <input type="number" id="fusible-${globalIndex}" placeholder="Fusible en Amperios">
                    
                    <label for="calibre-${globalIndex}"><b>4. Calibre CGP seleccionado en A:</b> <span style="color: #6c757d;">(0.8 pts)</span></label>
                    <input type="number" id="calibre-${globalIndex}" placeholder="Calibre en Amperios">
                    
                    <label for="seccion-lga-${globalIndex}"><b>5. Secci√≥n final de la LGA en mm¬≤:</b> <span style="color: #6c757d;">(0.8 pts)</span></label>
                    <input type="number" id="seccion-lga-${globalIndex}" placeholder="Secci√≥n LGA en mm¬≤">
                </div>
                <div id="feedback-${globalIndex}" class="feedback-area"></div>
            </div>
        `;
        
        contentArea.innerHTML += problemHTML;
    }

    // Crear bot√≥n para enviar examen al profesor
    const submitBtn = document.createElement('button');
    submitBtn.className = 'btn';
    submitBtn.textContent = 'üì§ Enviar Examen al Profesor';
    submitBtn.onclick = submitExamToTeacher;
    submitBtn.style.backgroundColor = '#dc3545';
    submitBtn.style.color = 'white';
    submitBtn.style.marginTop = '20px';
    console.log('Bot√≥n "Enviar Examen al Profesor" creado');
    
    // A√±adir el bot√≥n solo al √°rea de controles
    controlsArea.appendChild(submitBtn);
    
    // Asegurarse de que el √°rea de controles sea visible
    controlsArea.classList.remove('hidden');
    console.log('ControlsArea hecho visible, total de elementos:', controlsArea.children.length);
}

/**
 * Funci√≥n para corregir las respuestas del alumno
 * Compara las respuestas introducidas con las soluciones correctas
 * y env√≠a un informe autom√°tico a Google Sheets
 */
function checkAnswers() {
    let correctCount = 0; // Contador de respuestas correctas
    
    // Crear array con los datos de cada ejercicio para el informe
    const exercisesData = appState.generatedExercises.map((exercise, i) => {
        const feedbackArea = document.getElementById(`feedback-${i}`);
        const problemContainer = document.getElementById(`problem-${i}`);
        
        if (appState.currentBlock === 3) {
            // Manejo especial para el bloque 3 con m√∫ltiples respuestas
            return checkBlock3Answers(exercise, i, feedbackArea, problemContainer);
        } else {
            // Manejo para bloques 1 y 2 (solo potencia)
            return checkSimpleAnswer(exercise, i, feedbackArea, problemContainer);
        }
    });

    // Contar respuestas correctas para el bloque 3
    if (appState.currentBlock === 3) {
        correctCount = exercisesData.reduce((count, data) => count + data.correctCount, 0);
    } else {
        correctCount = exercisesData.filter(data => data.isCorrect).length;
    }

    // Desactivar el bot√≥n para evitar env√≠os m√∫ltiples y mostrar estado
    const checkBtn = controlsArea.querySelector('button');
    checkBtn.disabled = true;
    checkBtn.textContent = 'Enviando informe...';

    // Enviar resultados a Google Sheets
    sendResultsToGoogleSheets(correctCount, exercisesData);
}

/**
 * Funci√≥n espec√≠fica para corregir las respuestas del examen
 * Similar a checkAnswers pero para los 2 ejercicios del examen
 */
function checkExamAnswers() {
    let correctCount = 0; // Contador de respuestas correctas
    
    // Crear array con los datos de cada ejercicio del examen para el informe
    const exercisesData = appState.generatedExercises.map((exercise, i) => {
        const feedbackArea = document.getElementById(`feedback-${i}`);
        const problemContainer = document.getElementById(`problem-${i}`);
        
        // Los ejercicios del examen son siempre del bloque 3 (m√∫ltiples respuestas)
        return checkBlock3Answers(exercise, i, feedbackArea, problemContainer);
    });

    // Contar respuestas correctas del examen
    correctCount = exercisesData.reduce((count, data) => count + data.correctCount, 0);

    // Desactivar el bot√≥n para evitar env√≠os m√∫ltiples y mostrar estado
    const checkBtn = controlsArea.querySelector('button');
    checkBtn.disabled = true;
    checkBtn.textContent = 'Enviando resultados del examen...';

    // Enviar resultados del examen a Google Sheets con identificaci√≥n especial
    sendExamResultsToGoogleSheets(correctCount, exercisesData);
}

/**
 * Funci√≥n para verificar respuestas simples (bloques 1 y 2)
 */
function checkSimpleAnswer(exercise, index, feedbackArea, problemContainer) {
    const userAnswerInput = document.getElementById(`answer-${index}`);
    const userAnswer = parseFloat(userAnswerInput.value);
    const correctAnswer = parseFloat(exercise.resultado.toFixed(2));
    let isCorrect = false;

    // Verificar si la respuesta es correcta (tolerancia de 0.1W)
    if (Math.abs(userAnswer - correctAnswer) < 0.1) {
        // Respuesta correcta
        feedbackArea.innerHTML = `<p class="correct-answer">¬°Correcto! La respuesta es ${correctAnswer} W.</p>`;
        problemContainer.classList.remove('incorrect-feedback');
        isCorrect = true;
    } else {
        // Respuesta incorrecta - mostrar soluci√≥n completa
        feedbackArea.innerHTML = `
            <p>
                <span class="incorrect-answer">Tu respuesta: ${isNaN(userAnswer) ? 'Inv√°lida' : userAnswer + ' W'}</span>
                <br>
                <span class="correct-answer">Respuesta correcta: ${correctAnswer} W</span>
            </p>
            <h4>Resoluci√≥n Detallada:</h4>
            <div class="solucion">${exercise.solucion}</div>
            ${exercise.tablaCGP ? exercise.tablaCGP : ''}
        `;
        problemContainer.classList.add('incorrect-feedback');
    }

    return {
        question: exercise.enunciado.replace(/\n/g, ' '),
        studentAnswer: isNaN(userAnswer) ? 'Sin respuesta' : userAnswer + ' W',
        correctSolution: `${correctAnswer} W. Resoluci√≥n: ${exercise.solucion.replace(/\n/g, ' ')}`,
        isCorrect: isCorrect
    };
}

/**
 * Funci√≥n para verificar m√∫ltiples respuestas del bloque 3
 */
function checkBlock3Answers(exercise, index, feedbackArea, problemContainer) {
    // Obtener respuestas del usuario
    const userPT = parseFloat(document.getElementById(`pt-${index}`).value);
    const userIntensidad = parseFloat(document.getElementById(`intensidad-${index}`).value);
    const userFusible = parseFloat(document.getElementById(`fusible-${index}`).value);
    const userCalibre = parseFloat(document.getElementById(`calibre-${index}`).value);
    const userSeccionLGA = parseFloat(document.getElementById(`seccion-lga-${index}`).value);
    
    // Obtener respuestas correctas
    const correctPT = parseFloat(exercise.resultado.toFixed(2));
    const correctIntensidad = parseFloat(exercise.cgpInfo.intensidad);
    const correctFusible = exercise.fusibleInfo.fusible;
    const correctCalibre = exercise.cgpInfo.calibre;
    
    // Extraer secci√≥n final de LGA de la soluci√≥n
    const seccionLGAMatch = exercise.solucion.match(/Secci√≥n adoptada \(la mayor\): ([\d,]+) mm¬≤/);
    const correctSeccionLGA = seccionLGAMatch ? parseFloat(seccionLGAMatch[1]) : exercise.conductorInfo.seccion;
    
    // Verificar cada respuesta con tolerancias apropiadas
    const checks = [
        { name: 'PT', user: userPT, correct: correctPT, unit: 'W', tolerance: 0.5 },
        { name: 'Intensidad', user: userIntensidad, correct: correctIntensidad, unit: 'A', tolerance: 0.5 },
        { name: 'Fusible CGP', user: userFusible, correct: correctFusible, unit: 'A', tolerance: 0 },
        { name: 'Calibre CGP', user: userCalibre, correct: correctCalibre, unit: 'A', tolerance: 0 },
        { name: 'Secci√≥n LGA', user: userSeccionLGA, correct: correctSeccionLGA, unit: 'mm¬≤', tolerance: 0 }
    ];
    
    let correctCount = 0;
    let feedbackHTML = '<div style="margin-top: 10px;"><h4>Correcci√≥n:</h4>';
    
    checks.forEach(check => {
        const isCorrect = !isNaN(check.user) && Math.abs(check.user - check.correct) <= check.tolerance;
        if (isCorrect) correctCount++;
        
        const statusClass = isCorrect ? 'correct-answer' : 'incorrect-answer';
        const statusIcon = isCorrect ? '‚úì' : '‚úó';
        
        feedbackHTML += `
            <p>
                <span class="${statusClass}">${statusIcon} ${check.name}: 
                ${isNaN(check.user) ? 'Sin respuesta' : check.user + ' ' + check.unit}
                ${!isCorrect ? ` ‚Üí Correcto: ${check.correct} ${check.unit}` : ''}
                </span>
            </p>
        `;
    });
    
    feedbackHTML += `</div>`;
    
    // Si no todas las respuestas son correctas, mostrar soluci√≥n completa
    if (correctCount < checks.length) {
        feedbackHTML += `
            <h4>Resoluci√≥n Detallada:</h4>
            <div class="solucion">${exercise.solucion}</div>
        `;
        problemContainer.classList.add('incorrect-feedback');
    } else {
        feedbackHTML += `<p class="correct-answer"><strong>¬°Perfecto! Todas las respuestas son correctas.</strong></p>`;
        problemContainer.classList.remove('incorrect-feedback');
    }
    
    feedbackArea.innerHTML = feedbackHTML;
    
    return {
        question: exercise.enunciado.replace(/\n/g, ' '),
        studentAnswers: {
            PT: isNaN(userPT) ? 'Sin respuesta' : userPT + ' W',
            Intensidad: isNaN(userIntensidad) ? 'Sin respuesta' : userIntensidad + ' A',
            FusibleCGP: isNaN(userFusible) ? 'Sin respuesta' : userFusible + ' A',
            CalibreCGP: isNaN(userCalibre) ? 'Sin respuesta' : userCalibre + ' A',
            SeccionLGA: isNaN(userSeccionLGA) ? 'Sin respuesta' : userSeccionLGA + ' mm¬≤'
        },
        correctSolution: `PT: ${correctPT} W, I: ${correctIntensidad} A, Fusible: ${correctFusible} A, Calibre: ${correctCalibre} A, LGA: ${correctSeccionLGA} mm¬≤`,
        correctCount: correctCount,
        totalQuestions: checks.length
    };
}

/**
 * Funci√≥n as√≠ncrona para enviar los resultados a Google Sheets
 * @param {number} correctCount - N√∫mero de respuestas correctas
 * @param {Array} exercises - Array con los datos de cada ejercicio
 */
async function sendResultsToGoogleSheets(correctCount, exercises) {
    // URL del script de Google Apps Script que recibe los datos
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzLZvn9QQ53F97Gk98S-LWYPBCAKGg-Oic5BoFJ0OaOu4UpYoec37zKgmbcNl5Dtwj4/exec";

    // Preparar los datos para enviar
    const payload = {
        studentName: appState.currentStudent,
        correctCount: correctCount,
        exercises: exercises
    };

    try {
        // Realizar petici√≥n POST a Google Apps Script
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors', // Importante para evitar errores de CORS con Apps Script
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        // Como usamos 'no-cors', no podemos leer la respuesta. 
        // Asumimos que fue exitoso si no hay un error de red.
        const checkBtn = controlsArea.querySelector('button');
        checkBtn.textContent = '‚úî Informe Enviado';
        checkBtn.style.backgroundColor = '#28a745'; // Verde

    } catch (error) {
        // Manejar errores de red o del servidor
        console.error('Error al enviar los datos:', error);
        const checkBtn = controlsArea.querySelector('button');
        checkBtn.textContent = 'Error al Enviar';
        checkBtn.style.backgroundColor = '#dc3545'; // Rojo
        
        // Opcional: Reactivar el bot√≥n para reintentar despu√©s de 3 segundos
        setTimeout(() => {
            checkBtn.disabled = false;
            checkBtn.textContent = 'Corregir y Enviar de Nuevo';
            checkBtn.style.backgroundColor = ''; // Color original
        }, 3000);
    }
}

/**
 * Funci√≥n as√≠ncrona para enviar los resultados del examen a Google Sheets
 * Similar a sendResultsToGoogleSheets pero identifica espec√≠ficamente que es un examen
 * @param {number} correctCount - N√∫mero de respuestas correctas en el examen
 * @param {Array} exercises - Array con los datos de cada ejercicio del examen
 */
async function sendExamResultsToGoogleSheets(correctCount, exercises) {
    // URL del script de Google Apps Script que recibe los datos
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyrKNjZ3MPVHSj_xwlIfIDi1VUL7rKenwVzGVEEPPxG-I-a9pVjRoTjT0AgFNw1eJ9h/exec";

    // Preparar los datos para enviar, marcando que es un examen
    const payload = {
        studentName: appState.currentStudent,
        correctCount: correctCount,
        exercises: exercises,
        isExam: true, // Identificador especial para ex√°menes
        examType: "Bloque 3 - Edificios con LGA", // Tipo de examen
        totalQuestions: exercises.length * 5 // 5 preguntas por ejercicio en el examen
    };

    try {
        // Realizar petici√≥n POST a Google Apps Script
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors', // Importante para evitar errores de CORS con Apps Script
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        // Como usamos 'no-cors', no podemos leer la respuesta. 
        // Asumimos que fue exitoso si no hay un error de red.
        const checkBtn = controlsArea.querySelector('button');
        checkBtn.textContent = '‚úî Examen Enviado';
        checkBtn.style.backgroundColor = '#28a745'; // Verde
        
        // Mostrar mensaje de √©xito espec√≠fico para el examen
        const successMessage = document.createElement('div');
        successMessage.style.cssText = 'margin-top: 15px; padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 5px;';
        successMessage.innerHTML = `<strong>¬°Examen completado!</strong> Tus resultados han sido enviados correctamente. Puntuaci√≥n: ${correctCount} de ${exercises.length * 5} respuestas correctas.`;
        controlsArea.appendChild(successMessage);

    } catch (error) {
        // Manejar errores de red o del servidor
        console.error('Error al enviar los datos del examen:', error);
        const checkBtn = controlsArea.querySelector('button');
        checkBtn.textContent = 'Error al Enviar Examen';
        checkBtn.style.backgroundColor = '#dc3545'; // Rojo
        
        // Opcional: Reactivar el bot√≥n para reintentar despu√©s de 3 segundos
        setTimeout(() => {
            checkBtn.disabled = false;
            checkBtn.textContent = 'Corregir Examen';
            checkBtn.style.backgroundColor = ''; // Color original
        }, 3000);
    }
}

// ================================================================
// SECCI√ìN 5: FUNCIONES DE GRABACI√ìN Y ENV√çO AL PROFESOR
// ================================================================

/**
 * Funci√≥n para iniciar la grabaci√≥n de pantalla
 * Abre una herramienta de grabaci√≥n externa en una nueva pesta√±a
 */
function startRecording() {
    // Abrir herramienta de grabaci√≥n de pantalla externa
    window.open('https://screencapture.com/', '_blank');
    
    // Mostrar informaci√≥n al usuario sobre la grabaci√≥n
    alert('Se ha abierto una herramienta de grabaci√≥n de pantalla.\n\n' +
          'IMPORTANTE:\n' +
          '1. Graba tu pantalla mientras resuelves el examen\n' +
          '2. Al finalizar, descarga el video\n' +
          '3. Sube el video al ClassRoom\n\n' +
          'Pulsa Aceptar para continuar con el examen.');
    
    // Mostrar el bot√≥n "Comenzar Examen" despu√©s de iniciar la grabaci√≥n
    const examStartBtn = document.getElementById('examStartBtn');
    if (examStartBtn) {
        examStartBtn.style.display = 'inline-block';
    }
    
    // Ocultar el bot√≥n "Iniciar Grabaci√≥n" despu√©s de hacer clic
    const recordingBtn = event.target;
    if (recordingBtn) {
        recordingBtn.style.display = 'none';
    }
}

/**
 * Funci√≥n para validar la contrase√±a del examen
 * Solo permite acceso al modo examen con la contrase√±a correcta
 */
function validateExamPassword() {
    const enteredPassword = prompt('Introduce la contrase√±a del examen:');
    if (enteredPassword === examPassword) {
        return true;
    } else {
        alert('Contrase√±a incorrecta. No se puede acceder al examen.');
        return false;
    }
}

/**
 * Funci√≥n para enviar el examen resuelto al profesor
 * Recopila todas las respuestas y las env√≠a via Google Sheets
 */
function submitExamToTeacher() {
    console.log('=== INICIO ENV√çO EXAMEN AL PROFESOR ===');
    
    // Verificar que hay ejercicios generados
    if (!appState.generatedExercises || appState.generatedExercises.length === 0) {
        alert('Error: No hay ejercicios para enviar. Genera primero los ejercicios del examen.');
        return;
    }
    
    // Contar respuestas completadas seg√∫n el tipo de ejercicio
    let filledCount = 0;
    let totalInputs = 0;
    
    // Recopilar todos los inputs del examen
    for (let i = 0; i < appState.generatedExercises.length; i++) {
        const exercise = appState.generatedExercises[i];
        
        if (exercise.bloque === 1) {
            // Bloque 1: solo tiene un input (answer)
            const input = document.getElementById(`answer-${i}`);
            if (input) {
                totalInputs++;
                if (input.value.trim() !== "") filledCount++;
            }
        } else {
            // Bloque 3: tiene 5 inputs
            const inputs = [
                document.getElementById(`pt-${i}`),
                document.getElementById(`intensidad-${i}`),
                document.getElementById(`fusible-${i}`),
                document.getElementById(`calibre-${i}`),
                document.getElementById(`seccion-lga-${i}`)
            ];
            
            inputs.forEach(input => {
                if (input) {
                    totalInputs++;
                    if (input.value.trim() !== "") filledCount++;
                }
            });
        }
    }
    
    console.log('Total inputs:', totalInputs, 'Rellenados:', filledCount);
    
    // Si hay preguntas sin completar, mostrar confirmaci√≥n
    if (filledCount < totalInputs) {
        const emptyCount = totalInputs - filledCount;
        const confirmMessage = `Tienes ${emptyCount} respuesta(s) sin completar. ¬øEst√°s seguro de que quieres enviar el examen?`;
        if (!confirm(confirmMessage)) {
            return;
        }
    }
    
    // Recopilar datos del examen
    const examData = collectExamDataForTeacher();
    
    console.log('Datos del examen recopilados:', examData);
    
    // Enviar a Google Sheets
    sendExamToGoogleSheets(examData);
    
    // Mostrar mensajes de confirmaci√≥n con la puntuaci√≥n
    const puntuacion = examData.score.toFixed(2);
    const maxPuntos = examData.maxScore;
    alert(`¬°Examen enviado correctamente al profesor!\n\nPuntuaci√≥n: ${puntuacion} de ${maxPuntos} puntos\n\nRECORDATORIO: No olvides:\n1. Finalizar la grabaci√≥n de pantalla\n2. Descargar el video\n3. Subirlo al ClassRoom`);
    
    // Deshabilitar el bot√≥n para evitar env√≠os m√∫ltiples
    const submitBtn = Array.from(controlsArea.children).find(btn => btn.textContent.includes('Enviar Examen'));
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = `‚úì Examen Enviado (${puntuacion}/${maxPuntos} pts)`;
        submitBtn.style.backgroundColor = '#6c757d';
    }
}

/**
 * Funci√≥n para recopilar los datos del examen para env√≠o al profesor
 * Puntuaci√≥n: Bloque 1 = 0.5 pts/ejercicio, Bloque 3 = 0.8 pts/apartado
 */
function collectExamDataForTeacher() {
    // Crear array de detailedResults en el formato que espera el backend (code2.gs)
    const detailedResults = [];
    let score = 0;
    let questionNumber = 1;
    
    // Constantes de puntuaci√≥n
    const PUNTOS_BLOQUE1 = 0.5;  // 0.5 puntos por ejercicio del bloque 1
    const PUNTOS_BLOQUE3 = 0.8;  // 0.8 puntos por apartado del bloque 3
    
    appState.generatedExercises.forEach((exercise, index) => {
        // Determinar si es ejercicio del bloque 1 o bloque 3
        const esBloque1 = exercise.bloque === 1;
        
        if (esBloque1) {
            // === BLOQUE 1: Cargas simples (0.5 pts) ===
            const userAnswer = document.getElementById(`answer-${index}`)?.value || '';
            const correctAnswer = parseFloat(exercise.resultado.toFixed(2));
            const isCorrect = userAnswer && Math.abs(parseFloat(userAnswer) - correctAnswer) < 1;
            
            detailedResults.push({
                questionNumber: questionNumber++,
                question: `Parte A - Ej.${index + 1} - Carga Simple`,
                userAnswer: userAnswer ? `${userAnswer} W` : 'Sin respuesta',
                correctAnswer: `${correctAnswer} W`,
                resolution: exercise.solucion.replace(/\n/g, ' ').substring(0, 200) + '...',
                isCorrect: isCorrect,
                puntos: PUNTOS_BLOQUE1
            });
            if (isCorrect) score += PUNTOS_BLOQUE1;
            
        } else {
            // === BLOQUE 3: Edificios con LGA (0.8 pts por apartado) ===
            // Obtener respuestas del usuario
            const userPT = document.getElementById(`pt-${index}`)?.value || '';
            const userIntensidad = document.getElementById(`intensidad-${index}`)?.value || '';
            const userFusible = document.getElementById(`fusible-${index}`)?.value || '';
            const userCalibre = document.getElementById(`calibre-${index}`)?.value || '';
            const userSeccionLGA = document.getElementById(`seccion-lga-${index}`)?.value || '';
            
            // Obtener respuestas correctas
            const correctPT = parseFloat(exercise.resultado.toFixed(2));
            const correctIntensidad = parseFloat(exercise.cgpInfo.intensidad);
            const correctFusible = exercise.fusibleInfo.fusible;
            const correctCalibre = exercise.cgpInfo.calibre;
            const seccionLGAMatch = exercise.solucion.match(/Secci√≥n adoptada \(la mayor\): ([\d,]+) mm¬≤/);
            const correctSeccionLGA = seccionLGAMatch ? parseFloat(seccionLGAMatch[1]) : (exercise.conductorInfo ? exercise.conductorInfo.seccion : 0);
            
            // Extraer datos adicionales del ejercicio para los c√°lculos detallados
            const factorPotencia = exercise.factorPotencia || 0.9;
            const longitudLGA = exercise.longitudLGA || 30;
            const intensidad110 = correctIntensidad * 1.1;
            
            // Calcular n√∫mero de ejercicio B (restando los del bloque 1)
            const numEjBloque1 = appState.generatedExercises.filter(e => e.bloque === 1).length;
            const ejBNum = index - numEjBloque1 + 1;
            
            // Verificar respuestas correctas
            const ptCorrect = userPT && Math.abs(parseFloat(userPT) - correctPT) < 1;
            const intensidadCorrect = userIntensidad && Math.abs(parseFloat(userIntensidad) - correctIntensidad) < 1;
            const fusibleCorrect = userFusible && parseFloat(userFusible) === correctFusible;
            const calibreCorrect = userCalibre && parseFloat(userCalibre) === correctCalibre;
            const seccionCorrect = userSeccionLGA && parseFloat(userSeccionLGA) === correctSeccionLGA;
            
            // Crear entrada para PT con c√°lculo detallado
            detailedResults.push({
                questionNumber: questionNumber++,
                question: `Parte B - Ej.${ejBNum} - Potencia Total (PT)`,
                userAnswer: userPT ? `${userPT} W` : 'Sin respuesta',
                correctAnswer: `${correctPT} W`,
                resolution: `PT = PH + PSG + PLC + PG + PVE = ${correctPT} W`,
                isCorrect: ptCorrect,
                puntos: PUNTOS_BLOQUE3
            });
            if (ptCorrect) score += PUNTOS_BLOQUE3;
            
            // Crear entrada para Intensidad con c√°lculo detallado
            detailedResults.push({
                questionNumber: questionNumber++,
                question: `Parte B - Ej.${ejBNum} - Intensidad calculada`,
                userAnswer: userIntensidad ? `${userIntensidad} A` : 'Sin respuesta',
                correctAnswer: `${correctIntensidad} A`,
                resolution: `I = P/(‚àö3√óU√ócosœÜ) = ${correctPT}/(1.732√ó400√ó${factorPotencia}) = ${correctIntensidad} A`,
                isCorrect: intensidadCorrect,
                puntos: PUNTOS_BLOQUE3
            });
            if (intensidadCorrect) score += PUNTOS_BLOQUE3;
            
            // Crear entrada para Fusible con c√°lculo detallado
            detailedResults.push({
                questionNumber: questionNumber++,
                question: `Parte B - Ej.${ejBNum} - Fusible CGP`,
                userAnswer: userFusible ? `${userFusible} A` : 'Sin respuesta',
                correctAnswer: `${correctFusible} A`,
                resolution: `Fusible ‚â• I√ó1.1 = ${correctIntensidad}√ó1.1 = ${intensidad110.toFixed(2)} A ‚Üí Normalizado: ${correctFusible} A`,
                isCorrect: fusibleCorrect,
                puntos: PUNTOS_BLOQUE3
            });
            if (fusibleCorrect) score += PUNTOS_BLOQUE3;
            
            // Crear entrada para Calibre con c√°lculo detallado
            detailedResults.push({
                questionNumber: questionNumber++,
                question: `Parte B - Ej.${ejBNum} - Calibre CGP`,
                userAnswer: userCalibre ? `${userCalibre} A` : 'Sin respuesta',
                correctAnswer: `${correctCalibre} A`,
                resolution: `Calibre ‚â• Fusible (${correctFusible} A) ‚Üí Normalizado: ${correctCalibre} A`,
                isCorrect: calibreCorrect,
                puntos: PUNTOS_BLOQUE3
            });
            if (calibreCorrect) score += PUNTOS_BLOQUE3;
            
            // Crear entrada para Secci√≥n LGA con c√°lculo detallado
            detailedResults.push({
                questionNumber: questionNumber++,
                question: `Parte B - Ej.${ejBNum} - Secci√≥n LGA`,
                userAnswer: userSeccionLGA ? `${userSeccionLGA} mm¬≤` : 'Sin respuesta',
                correctAnswer: `${correctSeccionLGA} mm¬≤`,
                resolution: `Mayor de: Secci√≥n por intensidad (Fusible=${correctFusible}A) y Secci√≥n por c.d.t. (L=${longitudLGA}m) ‚Üí ${correctSeccionLGA} mm¬≤`,
                isCorrect: seccionCorrect,
                puntos: PUNTOS_BLOQUE3
            });
            if (seccionCorrect) score += PUNTOS_BLOQUE3;
        }
    });
    
    // Calcular totales
    const numBloque1 = appState.generatedExercises.filter(e => e.bloque === 1).length;
    const numBloque3 = appState.generatedExercises.filter(e => e.bloque === 3).length;
    const totalQuestions = numBloque1 + (numBloque3 * 5); // Bloque 1: 1 pregunta, Bloque 3: 5 preguntas
    const maxScore = (numBloque1 * PUNTOS_BLOQUE1) + (numBloque3 * 5 * PUNTOS_BLOQUE3); // 4√ó0.5 + 2√ó5√ó0.8 = 10
    
    const examData = {
        timestamp: new Date().toISOString(),
        studentName: appState.currentStudent,
        studentEmail: appState.currentStudent.replace(/\s+/g, '.').toLowerCase() + '@alumno.edu',
        testType: 'Examen_ITC-BT-10_Completo',
        language: 'es',
        score: parseFloat(score.toFixed(2)),
        totalQuestions: totalQuestions,
        maxScore: maxScore,
        passed: score >= (maxScore * 0.5), // Aprobado si tiene 50% o m√°s (5 puntos)
        detailedResults: detailedResults
    };
    
    return examData;
}

/**
 * Funci√≥n para enviar datos del examen a Google Sheets
 */
async function sendExamToGoogleSheets(examData) {
    if (!GOOGLE_SHEETS_CONFIG.ENABLED) {
        console.log('‚ùå Google Sheets reporting is DISABLED');
        if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
            alert('Google Sheets est√° deshabilitado. Contacta con el profesor.');
        }
        return;
    }
    
    if (!GOOGLE_SHEETS_CONFIG.WEB_APP_URL) {
        console.log('‚ùå WEB_APP_URL not configured');
        alert('Error de configuraci√≥n. Contacta con el profesor.');
        return;
    }
    
    try {
        if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
            console.log('üì§ Enviando datos del examen a Google Sheets...', examData);
        }
        
        // El payload ya viene en el formato correcto desde collectExamDataForTeacher()
        // con: studentName, testType, correctCount, exercises[]
        const response = await fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(examData),
            mode: 'no-cors' // Necesario para Google Apps Script
        });
        
        console.log('‚úÖ Examen enviado a Google Sheets correctamente');
        
        if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
            showNotification('‚úÖ Examen enviado correctamente', 'success');
        }
        
    } catch (error) {
        console.error('‚ùå Error enviando examen a Google Sheets:', error);
        if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
            showNotification('‚ùå Error enviando examen: ' + error.message, 'error');
        }
    }
}

/**
 * Funci√≥n para mostrar notificaciones visuales al usuario
 */
function showNotification(message, type = 'info') {
    // Crear elemento de notificaci√≥n
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    
    // Configurar estilo seg√∫n el tipo
    switch (type) {
        case 'success':
            notification.style.backgroundColor = '#28a745';
            break;
        case 'error':
            notification.style.backgroundColor = '#dc3545';
            break;
        case 'warning':
            notification.style.backgroundColor = '#ffc107';
            notification.style.color = '#000';
            break;
        default:
            notification.style.backgroundColor = '#007bff';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remover autom√°ticamente despu√©s de 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

/**
 * Funci√≥n principal para generar ejercicios seg√∫n el bloque
 * @param {number} block - N√∫mero del bloque (1, 2 o 3)
 * @returns {Object} Objeto con enunciado, soluci√≥n y resultado del ejercicio
 */
function generateExercise(block) {
    let exercise;
    let unique = false;
    const existingEnunciados = appState.generatedExercises.map(ex => ex.enunciado);

    // Bucle para evitar ejercicios repetidos en la misma p√°gina
    while (!unique) {
        if (block === 1) {
            exercise = generarCargaSimple(); // Ejercicios simples
        } else if (block === 2) {
            exercise = generarEdificioCompleto(false); // Edificios sin LGA
        } else { // Bloque 3
            exercise = generarEdificioCompleto(true); // Edificios con LGA
        }
        
        // Verificar que el enunciado no est√© repetido
        if (!existingEnunciados.includes(exercise.enunciado)) {
            unique = true;
        }
    }
    return exercise;
}

// ================================================================
// SECCI√ìN 4: GENERADOR DE EJERCICIOS - ITC-BT-10
// ================================================================

/**
 * Esta secci√≥n contiene toda la l√≥gica para generar ejercicios autom√°ticamente
 * basados en la normativa ITC-BT-10 para previsi√≥n de cargas el√©ctricas
 */

// ================================================================
// SUBSECCI√ìN 4.1: BASES DE DATOS Y CONSTANTES NORMATIVAS
// ================================================================

/**
 * Datos de ascensores normalizados seg√∫n clasificaci√≥n ITA
 * Cada tipo tiene una potencia espec√≠fica en Watts
 */
const DATOS_ASCENSORES = {
    "ITA-1": { potencia: 4500 },   // Ascensor peque√±o
    "ITA-2": { potencia: 7500 },   // Ascensor mediano
    "ITA-3": { potencia: 11500 },  // Ascensor grande
    "ITA-4": { potencia: 18500 },  // Ascensor muy grande
    "ITA-5": { potencia: 29500 },  // Ascensor industrial peque√±o
    "ITA-6": { potencia: 46000 }   // Ascensor industrial grande
};

/**
 * Descripci√≥n de m√©todos de instalaci√≥n seg√∫n ITC-BT-19
 * Define c√≥mo se instalan los conductores el√©ctricos
 */
const methodDesc = {
    'B1': [
        'Conductors unipolars a√Øllats en tubs en muntatge superficial o encastats en obra',
        'Conductors unipolars a√Øllats en sobre paret de fusta o separats a una dist√†ncia inferior a 0,3 vegades el di√†metre del tub',
        'Conductors unipolars a√Øllats en conductes de secci√≥ no circular sobre paret de fusta',
        'Conductors unipolars a√Øllats en conductes encastats en paret d\'obra',
        'Cables unipolars o multiconductors en buits d\'obra de f√†brica',
        'Conductors unipolars a√Øllats en tubs dins de buits d\'obra de f√†brica',
        'Conductors unipolars a√Øllats en conductes de secci√≥ no circular en buits d\'obra de f√†brica',
        'Conductors unipolars a√Øllats o cables unipolars en canal protectora fixades a una paret de fusta o encastades en el s√≤l',
        'Cables uni o multiconductors en falsos sostres o sostres suspesos',
        'Conductors unipolars a√Øllats en canal protectora suspesa',
        'Conductors unipolars a√Øllats en canals d\'obra ventilats',
        'Cables uni o multiconductors en canals d\'obra ventilats',
        'Conductors unipolars a√Øllats o cables unipolars dins de s√≤cols acanalats'
    ],
    'D': 'Cables multiconductors enterrats sota tub', // M√©todo para cables enterrados
};

/**
 * Tabla de ampacidad seg√∫n ITC-BT-19
 * Define la intensidad m√°xima que puede soportar cada secci√≥n de conductor
 * Organizada por material (cobre/aluminio) y m√©todo de instalaci√≥n
 */
const AMPACIDAD_ITC_BT_19 = {
    "cobre": {
        // M√©todo B1: Conductores en tubos superficiales o empotrados
        "B1": { 10: 57, 16: 77, 25: 100, 35: 124, 50: 151, 70: 193, 95: 234, 120: 272, 150: 313, 185: 356, 240: 419 },
        // M√©todo D: Cables enterrados
        "D": { 10: 58, 16: 75, 25: 96, 35: 117, 50: 138, 70: 170, 95: 202, 120: 230, 150: 260, 185: 291, 240: 336, 300: 380 }
    },
    "aluminio": {
        // M√©todo B1: Conductores en tubos superficiales o empotrados
        "B1": { 16: 60, 25: 75, 35: 93, 50: 113, 70: 145, 95: 177, 120: 205, 150: 237, 185: 271, 240: 320 },
        // M√©todo D: Cables enterrados
        "D": { 16: 58, 25: 74, 35: 90, 50: 107, 70: 132, 95: 157, 120: 178, 150: 201, 185: 226, 240: 261, 300: 295 }
    }
};

/**
 * Coeficientes de simultaneidad para viviendas
 * Array donde el √≠ndice representa el n√∫mero de viviendas y el valor el coeficiente
 */
const COEFICIENTES_SIMULTANEIDAD = [1, 2, 3, 3.8, 4.6, 5.4, 6.2, 7, 7.8, 8.5, 9.2, 9.9, 10.6, 11.3, 11.9, 12.5, 13.1, 13.7, 14.3, 14.8, 15.3];

/**
 * Calibres de CGP (Cuadro General de Protecci√≥n) normalizados en Amperios
 * Estos son los valores est√°ndar disponibles comercialmente
 */
const CALIBRES_CGP_NORMALIZADOS = [40, 63, 80, 100, 160, 250, 400];

/**
 * Fusibles de CGP normalizados en Amperios
 * Valores est√°ndar de fusibles disponibles comercialmente
 */
const FUSIBLES_CGP_NORMALIZADOS = [16, 20, 25, 32, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 335, 400];

// Potencias m√≠nimas seg√∫n la normativa ITC-BT-10
const POTENCIA_MIN_BASICA = 5750;      // Watts para electrificaci√≥n b√°sica
const POTENCIA_MIN_ELEVADA = 9200;     // Watts para electrificaci√≥n elevada
const MIN_LOCAL_GARAJE = 3450;         // Potencia m√≠nima para locales y garajes

// Potencias por superficie seg√∫n tipo de uso
const W_POR_M2_LOCAL = 100;            // Watts por m¬≤ para locales comerciales
const W_POR_M2_GARAJE_NAT = 10;        // Watts por m¬≤ para garajes con ventilaci√≥n natural
const W_POR_M2_GARAJE_FOR = 20;        // Watts por m¬≤ para garajes con ventilaci√≥n forzada
const POTENCIA_RECARGA_VE = 3680;      // Watts por punto de recarga de veh√≠culo el√©ctrico

// Propiedades el√©ctricas de los conductores
const CONDUCTIVIDAD_COBRE = 45.49;     // Conductividad del cobre en m/Œ©¬∑mm¬≤
const CONDUCTIVIDAD_ALUMINIO = 27.8;   // Conductividad del aluminio en m/Œ©¬∑mm¬≤

// L√≠mites t√©cnicos
const MAX_CAIDA_TENSION_LGA = 0.5;     // M√°xima ca√≠da de tensi√≥n admisible en LGA (%)

// ================================================================
// SUBSECCI√ìN 4.2: FUNCIONES AUXILIARES
// ================================================================

/**
 * Genera un n√∫mero entero aleatorio entre min y max (inclusive)
 * @param {number} min - Valor m√≠nimo
 * @param {number} max - Valor m√°ximo
 * @returns {number} N√∫mero entero aleatorio
 */
function randInt(min, max) { 
    return Math.floor(Math.random() * (max - min + 1)) + min; 
}

/**
 * Selecciona un elemento aleatorio de un array
 * @param {Array} arr - Array del cual seleccionar
 * @returns {*} Elemento aleatorio del array
 */
function randChoice(arr) { 
    return arr[Math.floor(Math.random() * arr.length)]; 
}

/**
 * Obtiene el coeficiente de simultaneidad para un n√∫mero determinado de viviendas
 * Seg√∫n la tabla normativa de la ITC-BT-10
 * @param {number} n - N√∫mero de viviendas
 * @returns {number} Coeficiente de simultaneidad
 */
function getCoefSimultaneidad(n) {
    if (n <= 0) return 0;
    if (n <= 21) return COEFICIENTES_SIMULTANEIDAD[n - 1];
    // Para m√°s de 21 viviendas, se contin√∫a con incremento de 0.5
    return 15.3 + (n - 21) * 0.5;
}

/**
 * Obtiene las secciones normalizadas disponibles para un material y m√©todo espec√≠fico
 * @param {string} material - 'cobre' o 'aluminio'
 * @param {string} metodo - M√©todo de instalaci√≥n ('B1', 'D', etc.)
 * @returns {Array} Array de secciones disponibles ordenadas de menor a mayor
 */
function getSeccionesNormalizadas(material, metodo) {
    const tabla = AMPACIDAD_ITC_BT_19[material]?.[metodo];
    if (!tabla) return [];
    return Object.keys(tabla).map(s => parseInt(s)).sort((a, b) => a - b);
}

/**
 * Selecciona la primera secci√≥n normalizada mayor o igual a la calculada
 * @param {number} seccionCalculada - Secci√≥n calculada matem√°ticamente
 * @param {string} material - Material del conductor
 * @param {string} metodo - M√©todo de instalaci√≥n
 * @returns {number} Secci√≥n normalizada seleccionada
 */
function seleccionarSeccionNormalizada(seccionCalculada, material, metodo) {
    const secciones = getSeccionesNormalizadas(material, metodo);
    for (let seccion of secciones) {
        if (seccion >= seccionCalculada) {
            return seccion;
        }
    }
    // Si no se encuentra ninguna secci√≥n mayor, devolver la mayor disponible
    return secciones[secciones.length - 1] || seccionCalculada;
}

// ================================================================
// SUBSECCI√ìN 4.3: FUNCIONES PARA C√ÅLCULOS DE CGP Y CONDUCTORES
// ================================================================

/**
 * Selecciona el calibre de CGP normalizado seg√∫n la potencia
 * @param {number} potenciaW - Potencia en Watts
 * @param {number} tension - Tensi√≥n de alimentaci√≥n (defecto: 400V trif√°sica)
 * @param {number} cosfi - Factor de potencia (defecto: 0.9)
 * @returns {Object} Informaci√≥n completa del calibre CGP seleccionado
 */
function getCalibreCGP(potenciaW, tension = 400, cosfi = 0.9) {
    // Calcular la intensidad nominal para sistema trif√°sico
    const intensidad = potenciaW / (Math.sqrt(3) * tension * cosfi);
    
    // Encontrar el calibre normalizado inmediatamente superior
    for (let calibre of CALIBRES_CGP_NORMALIZADOS) {
        if (calibre >= intensidad) {
            return {
                intensidad: intensidad.toFixed(2),
                calibre: calibre,
                potenciaW: potenciaW,
                tension: tension,
                cosfi: cosfi
            };
        }
    }
    
    // Si ning√∫n calibre es suficiente, devolver el mayor disponible
    return {
        intensidad: intensidad.toFixed(2),
        calibre: CALIBRES_CGP_NORMALIZADOS[CALIBRES_CGP_NORMALIZADOS.length - 1],
        potenciaW: potenciaW,
        tension: tension,
        cosfi: cosfi,
        warning: "Potencia superior al calibre m√°ximo normalizado"
    };
}

/**
 * Selecciona el fusible de CGP normalizado seg√∫n la potencia
 * @param {number} potenciaW - Potencia en Watts
 * @param {number} tension - Tensi√≥n de alimentaci√≥n (defecto: 400V trif√°sica)
 * @param {number} cosfi - Factor de potencia (defecto: 0.9)
 * @returns {Object} Informaci√≥n completa del fusible CGP seleccionado
 */
function getFusibleCGP(potenciaW, tension = 400, cosfi = 0.9) {
    // Calcular la intensidad nominal para sistema trif√°sico
    const intensidad = potenciaW / (Math.sqrt(3) * tension * cosfi);
    
    // Encontrar el fusible normalizado inmediatamente superior
    for (let fusible of FUSIBLES_CGP_NORMALIZADOS) {
        if (fusible >= intensidad) {
            return {
                intensidad: intensidad.toFixed(2),
                fusible: fusible,
                potenciaW: potenciaW,
                tension: tension,
                cosfi: cosfi
            };
        }
    }
    
    // Si ning√∫n fusible es suficiente, devolver el mayor disponible
    return {
        intensidad: intensidad.toFixed(2),
        fusible: FUSIBLES_CGP_NORMALIZADOS[FUSIBLES_CGP_NORMALIZADOS.length - 1],
        potenciaW: potenciaW,
        tension: tension,
        cosfi: cosfi,
        warning: "Potencia superior al fusible m√°ximo normalizado"
    };
}

/**
 * Genera una tabla HTML con los calibres CGP normalizados
 * Muestra todos los calibres disponibles y resalta el seleccionado
 * @param {number} potenciaW - Potencia para calcular el calibre (opcional)
 * @param {number} tension - Tensi√≥n del sistema (defecto: 400V)
 * @param {number} cosfi - Factor de potencia (defecto: 0.9)
 * @returns {string} HTML de la tabla completa
 */
function generarTablaCalibresCGP(potenciaW = null, tension = 400, cosfi = 0.9) {
    let html = `
        <div class="cgp-info">
            <h4>üìã Tabla de Calibres CGP Normalizados</h4>
            <p><strong>Tensi√≥n:</strong> ${tension} V (trif√°sica) | <strong>cos œÜ:</strong> ${cosfi}</p>
            <table class="cgp-table">
                <thead>
                    <tr>
                        <th>Calibre CGP (A)</th>
                        <th>Potencia M√°xima (kW)</th>
                        <th>Potencia M√°xima (W)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Determinar qu√© calibre est√° seleccionado (si se proporciona potencia)
    const calibreSeleccionado = potenciaW ? getCalibreCGP(potenciaW, tension, cosfi).calibre : null;
    
    // Generar filas para cada calibre normalizado
    CALIBRES_CGP_NORMALIZADOS.forEach(calibre => {
        const potenciaMaxW = calibre * Math.sqrt(3) * tension * cosfi;
        const potenciaMaxKW = (potenciaMaxW / 1000).toFixed(1);
        const isSelected = calibre === calibreSeleccionado;
        
        html += `
            <tr${isSelected ? ' class="cgp-selected"' : ''}>
                <td>${calibre} A${isSelected ? ' ‚úì' : ''}</td>
                <td>${potenciaMaxKW} kW</td>
                <td>${potenciaMaxW.toFixed(0)} W</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
    `;
    
    // A√±adir informaci√≥n espec√≠fica si se proporciona una potencia
    if (potenciaW) {
        const cgpInfo = getCalibreCGP(potenciaW, tension, cosfi);
        html += `
            <div style="margin-top: 15px; padding: 10px; background-color: #e7f3ff; border-left: 4px solid #005a9c;">
                <strong>Para una potencia de ${potenciaW.toFixed(0)} W:</strong><br>
                ‚Ä¢ Intensidad calculada: ${cgpInfo.intensidad} A<br>
                ‚Ä¢ Calibre CGP requerido: <strong>${cgpInfo.calibre} A</strong>
                ${cgpInfo.warning ? `<br>‚Ä¢ ‚ö†Ô∏è ${cgpInfo.warning}` : ''}
            </div>
        `;
    }
    
    html += `</div>`;
    return html;
}

// Funci√≥n para generar la tabla de fusibles CGP normalizados
function generarTablaFusiblesCGP(potenciaW = null, tension = 400, cosfi = 0.9) {
    let html = `
        <div class="cgp-info">
            <h4>üîß Tabla de Fusibles CGP Normalizados</h4>
            <p><strong>Tensi√≥n:</strong> ${tension} V (trif√°sica) | <strong>cos œÜ:</strong> ${cosfi}</p>
            <table class="cgp-table">
                <thead>
                    <tr>
                        <th>Fusible CGP (A)</th>
                        <th>Potencia M√°xima (kW)</th>
                        <th>Potencia M√°xima (W)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const fusibleSeleccionado = potenciaW ? getFusibleCGP(potenciaW, tension, cosfi).fusible : null;
    
    FUSIBLES_CGP_NORMALIZADOS.forEach(fusible => {
        const potenciaMaxW = fusible * Math.sqrt(3) * tension * cosfi;
        const potenciaMaxKW = (potenciaMaxW / 1000).toFixed(1);
        const isSelected = fusible === fusibleSeleccionado;
        
        html += `
            <tr${isSelected ? ' class="cgp-selected"' : ''}>
                <td>${fusible} A${isSelected ? ' ‚úì' : ''}</td>
                <td>${potenciaMaxKW} kW</td>
                <td>${potenciaMaxW.toFixed(0)} W</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
    `;
    
    if (potenciaW) {
        const fusibleInfo = getFusibleCGP(potenciaW, tension, cosfi);
        html += `
            <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107;">
                <strong>Para una potencia de ${potenciaW.toFixed(0)} W:</strong><br>
                ‚Ä¢ Intensidad calculada: ${fusibleInfo.intensidad} A<br>
                ‚Ä¢ Fusible CGP requerido: <strong>${fusibleInfo.fusible} A</strong>
                ${fusibleInfo.warning ? `<br>‚Ä¢ ‚ö†Ô∏è ${fusibleInfo.warning}` : ''}
            </div>
        `;
    }
    
    html += `</div>`;
    return html;
}

// Funci√≥n para generar tabla combinada de calibres y fusibles CGP
function generarTablaCGPCompleta(potenciaW = null, tension = 400, cosfi = 0.9) {
    return generarTablaCalibresCGP(potenciaW, tension, cosfi) + generarTablaFusiblesCGP(potenciaW, tension, cosfi);
}

// --- FUNCIONES PARA AMPACIDAD ITC-BT-19 ---

// Funci√≥n para obtener la secci√≥n m√≠nima del conductor seg√∫n intensidad
function getSeccionConductor(intensidad, material = 'cobre', metodo = 'B1') {
    const tabla = AMPACIDAD_ITC_BT_19[material]?.[metodo];
    if (!tabla) {
        return {
            error: `Combinaci√≥n no v√°lida: material=${material}, m√©todo=${metodo}`
        };
    }
    
    // Buscar la secci√≥n m√≠nima que soporte la intensidad requerida
    for (const [seccion, intensidadMax] of Object.entries(tabla)) {
        if (intensidadMax >= intensidad) {
            return {
                seccion: parseInt(seccion),
                intensidadMax: intensidadMax,
                intensidadCalculada: intensidad,
                material: material,
                metodo: metodo,
                descripcion: methodDesc[metodo] || 'M√©todo no especificado'
            };
        }
    }
    
    // Si ninguna secci√≥n es suficiente, devolver la mayor disponible con advertencia
    const secciones = Object.keys(tabla).map(s => parseInt(s)).sort((a, b) => b - a);
    const seccionMaxima = secciones[0];
    return {
        seccion: seccionMaxima,
        intensidadMax: tabla[seccionMaxima],
        intensidadCalculada: intensidad,
        material: material,
        metodo: metodo,
        descripcion: methodDesc[metodo] || 'M√©todo no especificado',
        warning: `Intensidad requerida (${intensidad}A) superior a la m√°xima disponible (${tabla[seccionMaxima]}A)`
    };
}

// Funci√≥n para generar tabla de ampacidad ITC-BT-19
function generarTablaAmpacidad(intensidad = null, material = 'cobre', metodo = 'B1') {
    const tabla = AMPACIDAD_ITC_BT_19[material]?.[metodo];
    if (!tabla) {
        return `<div class="cgp-info"><p>‚ö†Ô∏è Combinaci√≥n no v√°lida: ${material} - ${metodo}</p></div>`;
    }
    
    const seccionSeleccionada = intensidad ? getSeccionConductor(intensidad, material, metodo).seccion : null;
    const descripcionMetodo = Array.isArray(methodDesc[metodo]) ? methodDesc[metodo][0] : methodDesc[metodo];
    
    let html = `
        <div class="cgp-info">
            <h4>üìê Tabla de Ampacidad ITC-BT-19</h4>
            <p><strong>Material:</strong> ${material.charAt(0).toUpperCase() + material.slice(1)} | <strong>M√©todo:</strong> ${metodo}</p>
            <p><em>${descripcionMetodo}</em></p>
            <table class="cgp-table">
                <thead>
                    <tr>
                        <th>Secci√≥n (mm¬≤)</th>
                        <th>Intensidad M√°xima (A)</th>
                        <th>Potencia M√°xima (kW)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    Object.entries(tabla).forEach(([seccion, intensidadMax]) => {
        const potenciaMaxKW = (intensidadMax * Math.sqrt(3) * 400 * 0.9 / 1000).toFixed(1);
        const isSelected = parseInt(seccion) === seccionSeleccionada;
        
        html += `
            <tr${isSelected ? ' class="cgp-selected"' : ''}>
                <td>${seccion} mm¬≤${isSelected ? ' ‚úì' : ''}</td>
                <td>${intensidadMax} A</td>
                <td>${potenciaMaxKW} kW</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
    `;
    
    if (intensidad) {
        const seccionInfo = getSeccionConductor(intensidad, material, metodo);
        html += `
            <div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-left: 4px solid #28a745;">
                <strong>Para una intensidad de ${intensidad} A:</strong><br>
                ‚Ä¢ Secci√≥n m√≠nima requerida: <strong>${seccionInfo.seccion} mm¬≤</strong><br>
                ‚Ä¢ Intensidad m√°xima admisible: ${seccionInfo.intensidadMax} A<br>
                ‚Ä¢ Material: ${seccionInfo.material}<br>
                ‚Ä¢ M√©todo de instalaci√≥n: ${seccionInfo.metodo}
                ${seccionInfo.warning ? `<br>‚Ä¢ ‚ö†Ô∏è ${seccionInfo.warning}` : ''}
            </div>
        `;
    }
    
    html += `</div>`;
    return html;
}

// Funci√≥n para generar informaci√≥n completa de conductores
function generarInfoCompleta(potenciaW, tension = 400, cosfi = 0.9, material = 'cobre', metodo = 'B1') {
    const intensidad = potenciaW / (Math.sqrt(3) * tension * cosfi);
    const cgpInfo = getCalibreCGP(potenciaW, tension, cosfi);
    const fusibleInfo = getFusibleCGP(potenciaW, tension, cosfi);
    const seccionInfo = getSeccionConductor(intensidad, material, metodo);
    
    return {
        potencia: potenciaW,
        intensidad: intensidad.toFixed(2),
        cgp: cgpInfo,
        fusible: fusibleInfo,
        conductor: seccionInfo,
        tablas: {
            cgp: generarTablaCGPCompleta(potenciaW, tension, cosfi),
            ampacidad: generarTablaAmpacidad(intensidad, material, metodo)
        }
    };
}

// --- GENERADOR BLOQUE 1: CARGAS SIMPLES ---
function generarCargaSimple() {
    const tipo = randChoice(['vivienda', 'local', 'garaje']);
    let enunciado = '', solucion = '', resultado = 0;

    if (tipo === 'vivienda') {
        const superficie = randInt(50, 250);
        const tieneAC = Math.random() > 0.6;
        const tieneCalefaccion = Math.random() > 0.6;
        let esElevada = superficie > 160 || tieneAC || tieneCalefaccion;
        
        enunciado = `Calcular la previsi√≥n de carga m√≠nima para una vivienda de ${superficie} m¬≤`;
        if (tieneAC) enunciado += ', con previsi√≥n de aire acondicionado';
        if (tieneCalefaccion) enunciado += ', con previsi√≥n de calefacci√≥n el√©ctrica';
        enunciado += '.';

        solucion = `1. Determinar el grado de electrificaci√≥n:\n`;
        let motivos = [];
        if (superficie > 160) motivos.push(`La superficie (${superficie} m¬≤) es superior a 160 m¬≤.`);
        if (tieneAC) motivos.push(`Se ha previsto instalaci√≥n de aire acondicionado.`);
        if (tieneCalefaccion) motivos.push(`Se ha previsto instalaci√≥n de calefacci√≥n el√©ctrica.`);
        
        if (esElevada) {
            resultado = POTENCIA_MIN_ELEVADA;
            solucion += motivos.map(m => `   - ${m}`).join('\n') + '\n';
            solucion += `2. Conclusi√≥n: Al cumplirse al menos una condici√≥n, el grado es Electrificaci√≥n Elevada.\n`;
            solucion += `3. Asignar potencia m√≠nima: La potencia a prever es ${resultado} W.`;
        } else {
            resultado = POTENCIA_MIN_BASICA;
            solucion += `   - No se cumple ninguna condici√≥n para electrificaci√≥n elevada.\n`;
            solucion += `2. Conclusi√≥n: El grado es Electrificaci√≥n B√°sica.\n`;
            solucion += `3. Asignar potencia m√≠nima: La potencia a prever es ${resultado} W.`;
        }
    } else if (tipo === 'local') {
        const superficie = randInt(20, 150);
        enunciado = `Calcular la previsi√≥n de carga para un local comercial de ${superficie} m¬≤.`;
        let cargaCalculada = superficie * W_POR_M2_LOCAL;
        resultado = Math.max(cargaCalculada, MIN_LOCAL_GARAJE);

        solucion = `1. Calcular potencia seg√∫n superficie (${W_POR_M2_LOCAL} W/m¬≤):\n`;
        solucion += `   P = ${superficie} m¬≤ √ó ${W_POR_M2_LOCAL} W/m¬≤ = ${cargaCalculada} W.\n`;
        solucion += `2. Comparar con el m√≠nimo por local comercial:\n`;
        solucion += `   M√≠nimo reglamentario = ${MIN_LOCAL_GARAJE} W.\n`;
        solucion += `3. Seleccionar el valor mayor:\n`;
        solucion += `   max(${cargaCalculada} W, ${MIN_LOCAL_GARAJE} W) = ${resultado} W.`;
    } else { // Garaje
        const superficie = randInt(80, 500);
        const ventilacion = randChoice(['natural', 'forzada']);
        const W_m2 = (ventilacion === 'natural') ? W_POR_M2_GARAJE_NAT : W_POR_M2_GARAJE_FOR;
        enunciado = `Calcular la previsi√≥n de carga para un garaje de ${superficie} m¬≤ con ventilaci√≥n ${ventilacion}.`;
        let cargaCalculada = superficie * W_m2;
        resultado = Math.max(cargaCalculada, MIN_LOCAL_GARAJE);
        
        solucion = `1. Calcular potencia seg√∫n tipo de ventilaci√≥n (${W_m2} W/m¬≤):\n`;
        solucion += `   P = ${superficie} m¬≤ √ó ${W_m2} W/m¬≤ = ${cargaCalculada} W.\n`;
        solucion += `2. Comparar con el m√≠nimo por garaje:\n`;
        solucion += `   M√≠nimo reglamentario = ${MIN_LOCAL_GARAJE} W.\n`;
        solucion += `3. Seleccionar el valor mayor:\n`;
        solucion += `   max(${cargaCalculada} W, ${MIN_LOCAL_GARAJE} W) = ${resultado} W.`;
    }
    return { enunciado, solucion, resultado };
}

// --- GENERADOR BLOQUES 2 Y 3: EDIFICIOS COMPLETOS ---
function generarEdificioCompleto(conLGA = false) {
    let PT, enunciado, solucion, PH, PSG, PLC, PG, PVE;
    let intentos = 0;
    const maxIntentos = 50; // Evitar bucle infinito
    
    do {
        intentos++;
        enunciado = 'Calcular la carga total prevista para un edificio con las siguientes caracter√≠sticas:\n';
        solucion = '';
        
        // 1. Viviendas (PH)
        const n_basicas = randInt(5, 20);
        const n_elevadas = randInt(2, 8);
        const totalViviendas = n_basicas + n_elevadas;
        const pTotalViv = (n_basicas * POTENCIA_MIN_BASICA) + (n_elevadas * POTENCIA_MIN_ELEVADA);
        const pMediaViv = pTotalViv / totalViviendas;
        const coefSimult = getCoefSimultaneidad(totalViviendas);
        PH = pMediaViv * coefSimult;
        enunciado += `- ${n_basicas} viviendas de electrificaci√≥n b√°sica.\n`;
        enunciado += `- ${n_elevadas} viviendas de electrificaci√≥n elevada.\n`;
        solucion += `1. Carga de Viviendas (PH)\n`;
        solucion += `   - P. media = ((${n_basicas} * ${POTENCIA_MIN_BASICA}) + (${n_elevadas} * ${POTENCIA_MIN_ELEVADA})) / ${totalViviendas} = ${pMediaViv.toFixed(2)} W.\n`;
        solucion += `   - Coef. Simultaneidad (${totalViviendas} viv.) = ${coefSimult}.\n`;
        solucion += `   - PH = ${pMediaViv.toFixed(2)} * ${coefSimult} = ${PH.toFixed(2)} W.\n\n`;

        // 2. Servicios Generales (PSG)
        const n_ascensores = randInt(1, 2);
        const tipo_ascensor_key = randChoice(Object.keys(DATOS_ASCENSORES));
        const ascensor = DATOS_ASCENSORES[tipo_ascensor_key];
        const pAscensores = n_ascensores * ascensor.potencia;
        const areaPortal = randInt(20, 50), areaEscalera = randInt(30, 80);
        const pAlumbrado = (areaPortal * 8) + (areaEscalera * 4); // Fluorescencia
        const n_plantas = randInt(3, 12);
        const pGrupoPresion = (n_plantas <= 4) ? 1000 : 2000;
        const pAuxiliares = 1000; // ICT
        PSG = pAscensores + pAlumbrado + pGrupoPresion + pAuxiliares;
        enunciado += `- Servicios generales: ${n_ascensores} ascensor(es) ${tipo_ascensor_key}, ${areaPortal} m¬≤ de portal, ${areaEscalera} m¬≤ de escalera, ${n_plantas} plantas.\n`;
        solucion += `2. Carga de Servicios Generales (PSG) (FS=1)\n`;
        solucion += `   - Ascensores: ${n_ascensores} * ${ascensor.potencia} W = ${pAscensores} W.\n`;
        solucion += `   - Alumbrado: (${areaPortal}*8) + (${areaEscalera}*4) = ${pAlumbrado} W.\n`;
        solucion += `   - Grupo presi√≥n: ${pGrupoPresion} W.\n`;
        solucion += `   - Auxiliares: ${pAuxiliares} W.\n`;
        solucion += `   - PSG = ${pAscensores} + ${pAlumbrado} + ${pGrupoPresion} + ${pAuxiliares} = ${PSG.toFixed(2)} W.\n\n`;

        // 3. Locales Comerciales (PLC)
        const n_locales = randInt(1, 3);
        PLC = 0;
        let localesTxt = '';
        solucion += `3. Carga de Locales Comerciales (PLC) (FS=1)\n`;
        for (let i = 0; i < n_locales; i++) {
            const area = randInt(30, 100);
            const cargaPorSuperficie = area * W_POR_M2_LOCAL;
            const cargaLocal = Math.max(cargaPorSuperficie, MIN_LOCAL_GARAJE);
            PLC += cargaLocal;
            localesTxt += `${area} m¬≤` + (i === n_locales - 1 ? '.\n' : ', ');
            solucion += `   - Local ${i + 1} (${area} m¬≤): ${area} √ó ${W_POR_M2_LOCAL} = ${cargaPorSuperficie} W ‚Üí max(${cargaPorSuperficie}, ${MIN_LOCAL_GARAJE}) = ${cargaLocal} W.\n`;
        }
        enunciado += `- ${n_locales} locales comerciales de: ${localesTxt}`;
        solucion += `   - PLC total = ${PLC.toFixed(2)} W.\n\n`;
        
        // 4. Garaje (PG)
        const areaGaraje = randInt(200, 800);
        const ventGaraje = randChoice(['natural', 'forzada']);
        const W_m2_g = (ventGaraje === 'natural') ? W_POR_M2_GARAJE_NAT : W_POR_M2_GARAJE_FOR;
        const cargaPorSuperficieGaraje = areaGaraje * W_m2_g;
        PG = Math.max(cargaPorSuperficieGaraje, MIN_LOCAL_GARAJE);
        enunciado += `- Garaje de ${areaGaraje} m¬≤ con ventilaci√≥n ${ventGaraje}.\n`;
        solucion += `4. Carga del Garaje (PG) (FS=1)\n`;
        solucion += `   - C√°lculo por superficie: ${areaGaraje} √ó ${W_m2_g} = ${cargaPorSuperficieGaraje} W.\n`;
        solucion += `   - PG = max(${cargaPorSuperficieGaraje}, ${MIN_LOCAL_GARAJE}) = ${PG.toFixed(2)} W.\n\n`;

        // 5. Veh√≠culo El√©ctrico (PVE)
        const plazas_aparcamiento = totalViviendas + n_locales;
        const plazas_recarga = Math.ceil(plazas_aparcamiento * 0.10);
        const tieneSPL = Math.random() > 0.5;
        const FS_VE = tieneSPL ? 0.3 : 1;
        PVE = POTENCIA_RECARGA_VE * plazas_recarga * FS_VE;
        enunciado += `- Recarga VE (${plazas_aparcamiento} plazas totales), ${tieneSPL ? 'con' : 'sin'} SPL.\n`;
        solucion += `5. Carga Veh√≠culo El√©ctrico (PVE)\n`;
        solucion += `   - Plazas totales: ${plazas_aparcamiento} plazas.\n`;
        solucion += `   - Plazas recarga (10%): ${plazas_aparcamiento} * 0.10 = ${(plazas_aparcamiento * 0.10).toFixed(1)} ‚Üí ${plazas_recarga} plazas (redondeado al entero superior).\n`;
        solucion += `   - Factor simultaneidad ${tieneSPL ? 'con' : 'sin'} SPL: ${FS_VE}.\n`;
        solucion += `   - PVE = ${POTENCIA_RECARGA_VE}W * ${plazas_recarga} plazas * ${FS_VE} = ${PVE.toFixed(2)} W.\n\n`;

        // 6. Total y LGA
        PT = PH + PSG + PLC + PG + PVE;
        solucion += `6. Carga Total del Edificio (PT)\n`;
        solucion += `   - PT = PH + PSG + PLC + PG + PVE\n`;
        solucion += `   - PT = ${PH.toFixed(2)} + ${PSG.toFixed(2)} + ${PLC.toFixed(2)} + ${PG.toFixed(2)} + ${PVE.toFixed(2)}\n`;
        solucion += `   - PT = ${PT.toFixed(2)} W = ${(PT/1000).toFixed(2)} kW.\n`;

    } while (conLGA && PT > 252000 && intentos < maxIntentos);

    const result = { 
        enunciado, 
        solucion, 
        resultado: PT
    };
    
    // Solo para el bloque 3: informaci√≥n sobre calibre, fusible CGP y conductor
    if (conLGA) {
        const longitudLGA = randInt(15, 50);
        const materialConductor = 'cobre';
        const sistemaInstalacion = 'B1';
        const descripcionSistema = 'conductores unipolares aislados en tubos en montaje superficial o empotrados en obra';
        const factorPotencia = (Math.random() * (1.0 - 0.8) + 0.8); // Entre 0.8 y 1.0
        const factorPotenciaRedondeado = Math.round(factorPotencia * 100) / 100; // Redondear a 2 decimales
        
        // Calcular intensidad nominal
        const intensidadCalculada = PT / (Math.sqrt(3) * 400 * factorPotenciaRedondeado);
        const intensidad110 = intensidadCalculada * 1.1; // 110% de la intensidad calculada
        
        // PASO 1: Seleccionar fusible que cumpla con el 110% de la intensidad calculada
        let fusibleSeleccionado = null;
        for (let fusible of FUSIBLES_CGP_NORMALIZADOS) {
            if (fusible >= intensidad110) {
                fusibleSeleccionado = fusible;
                break;
            }
        }
        
        // Si no se encuentra fusible adecuado, usar el mayor disponible
        if (!fusibleSeleccionado) {
            fusibleSeleccionado = FUSIBLES_CGP_NORMALIZADOS[FUSIBLES_CGP_NORMALIZADOS.length - 1];
        }
        
        // PASO 2: Seleccionar calibre CGP que sea mayor o igual al fusible
        let calibreCGPSeleccionado = null;
        for (let calibre of CALIBRES_CGP_NORMALIZADOS) {
            if (calibre >= fusibleSeleccionado) {
                calibreCGPSeleccionado = calibre;
                break;
            }
        }
        
        // Si no se encuentra calibre adecuado, usar el mayor disponible
        if (!calibreCGPSeleccionado) {
            calibreCGPSeleccionado = CALIBRES_CGP_NORMALIZADOS[CALIBRES_CGP_NORMALIZADOS.length - 1];
        }
        
        const conductorInfo = getSeccionConductor(fusibleSeleccionado, 'cobre', 'B1');
        
        solucion += `\n7. Selecci√≥n del Fusible y Calibre CGP\n`;
        solucion += `   - Intensidad calculada: I = P / (‚àö3 √ó U √ó cos œÜ) = ${PT.toFixed(0)} / (1.732 √ó 400 √ó ${factorPotenciaRedondeado}) = ${intensidadCalculada.toFixed(2)} A\n`;
        solucion += `   - Intensidad m√≠nima requerida (110%): ${intensidadCalculada.toFixed(2)} √ó 1.1 = ${intensidad110.toFixed(2)} A\n`;
        solucion += `   7.1. Selecci√≥n de fusible CGP:\n`;
        solucion += `        * Fusibles normalizados disponibles: ${FUSIBLES_CGP_NORMALIZADOS.join(', ')} A\n`;
        solucion += `        * Primer fusible ‚â• ${intensidad110.toFixed(2)} A: ${fusibleSeleccionado} A\n`;
        solucion += `        * Fusible CGP seleccionado: ${fusibleSeleccionado} A\n`;
        solucion += `   7.2. Selecci√≥n de calibre CGP:\n`;
        solucion += `        * Calibres normalizados disponibles: ${CALIBRES_CGP_NORMALIZADOS.join(', ')} A\n`;
        solucion += `        * Primer calibre ‚â• fusible (${fusibleSeleccionado} A): ${calibreCGPSeleccionado} A\n`;
        solucion += `        * Calibre CGP seleccionado: ${calibreCGPSeleccionado} A\n`;
        solucion += `   - Verificaci√≥n: Calibre CGP (${calibreCGPSeleccionado} A) ‚â• Fusible (${fusibleSeleccionado} A) ‚Üí ${calibreCGPSeleccionado >= fusibleSeleccionado ? 'CUMPLE' : 'NO CUMPLE'}\n`;
        
        solucion += `\n8. Selecci√≥n de la Secci√≥n del Conductor (ITC-BT-19)\n`;
        solucion += `   - Intensidad de referencia: ${fusibleSeleccionado} A (calibre del fusible CGP)\n`;
        solucion += `   - Material del conductor: ${materialConductor.charAt(0).toUpperCase() + materialConductor.slice(1)}\n`;
        solucion += `   - M√©todo de instalaci√≥n: ${sistemaInstalacion} (${descripcionSistema})\n`;
        solucion += `   - Secci√≥n m√≠nima requerida: ${conductorInfo.seccion} mm¬≤\n`;
        solucion += `   - Intensidad m√°xima admisible: ${conductorInfo.intensidadMax} A\n`;

        enunciado += `- La LGA tiene una longitud de ${longitudLGA} metros.\n`;
        enunciado += `- Material del conductor: ${materialConductor}.\n`;
        enunciado += `- Sistema de instalaci√≥n: ${descripcionSistema}.\n`;
        enunciado += `- Factor de potencia del edificio: ${factorPotenciaRedondeado}.`;
        
        solucion += `\n9. Verificaci√≥n del Sistema\n`;
        solucion += `   - Fusible CGP: ${fusibleSeleccionado} A\n`;
        solucion += `   - Calibre CGP: ${calibreCGPSeleccionado} A\n`;
        solucion += `   - Secci√≥n conductor: ${conductorInfo.seccion} mm¬≤\n`;
        
        solucion += `\n10. C√°lculo de la Secci√≥n de la LGA\n`;
        
        // C√°lculo por intensidad (ya calculado en paso 8)
        const seccionPorIntensidad = conductorInfo.seccion;
        solucion += `   10.1. Secci√≥n por intensidad (del paso 8): ${seccionPorIntensidad} mm¬≤\n`;
        
        // C√°lculo por ca√≠da de tensi√≥n
        const conductividad = materialConductor === 'cobre' ? CONDUCTIVIDAD_COBRE : CONDUCTIVIDAD_ALUMINIO;
        const potenciaKW = PT / 1000;
        const tension = 400; // Tensi√≥n entre fases en V
        const caidaTensionMaxima = MAX_CAIDA_TENSION_LGA / 100; // Convertir % a decimal
        const caidaTensionVoltios = tension * caidaTensionMaxima;
        
        // F√≥rmula: S = (L √ó P) / (Œ≥ √ó ŒîU √ó U)
        // donde Œ≥ es la conductividad
        const seccionCaidaTension = (longitudLGA * potenciaKW * 1000) / (conductividad * caidaTensionVoltios * tension);
        
        // Seleccionar secci√≥n normalizada de la tabla AMPACIDAD_ITC_BT_19
        const seccionesDisponibles = getSeccionesNormalizadas(materialConductor, sistemaInstalacion);
        const seccionNormalizada = seleccionarSeccionNormalizada(seccionCaidaTension, materialConductor, sistemaInstalacion);
        
        solucion += `   10.2. C√°lculo por ca√≠da de tensi√≥n:\n`;
        solucion += `        - Conductividad del ${materialConductor}: ${conductividad} m/Œ©¬∑mm¬≤\n`;
        solucion += `        - Ca√≠da de tensi√≥n m√°xima admisible: ${MAX_CAIDA_TENSION_LGA}% = ${caidaTensionVoltios.toFixed(1)} V\n`;
        solucion += `        - F√≥rmula: S = (L √ó P) / (Œ≥ √ó ŒîU √ó U)\n`;
        solucion += `        - S = (${longitudLGA} √ó ${potenciaKW.toFixed(2)} √ó 1000) / (${conductividad} √ó ${caidaTensionVoltios.toFixed(1)} √ó ${tension})\n`;
        solucion += `        - S calculada = ${seccionCaidaTension.toFixed(2)} mm¬≤\n`;
        solucion += `        - Secciones normalizadas disponibles (ITC-BT-19): ${seccionesDisponibles.join(', ')} mm¬≤\n`;
        solucion += `        - Primera secci√≥n normalizada ‚â• ${seccionCaidaTension.toFixed(2)} mm¬≤: ${seccionNormalizada} mm¬≤\n`;
        
        // Selecci√≥n de la mayor secci√≥n
        const seccionFinal = Math.max(seccionPorIntensidad, seccionNormalizada);
        solucion += `   10.3. Selecci√≥n final:\n`;
        solucion += `        - Secci√≥n por intensidad: ${seccionPorIntensidad} mm¬≤\n`;
        solucion += `        - Secci√≥n normalizada por ca√≠da de tensi√≥n: ${seccionNormalizada} mm¬≤\n`;
        solucion += `        - Secci√≥n adoptada (la mayor): ${seccionFinal} mm¬≤\n`;
        
        // Verificaci√≥n de la ca√≠da de tensi√≥n real
        const caidaTensionReal = (longitudLGA * potenciaKW * 1000) / (conductividad * seccionFinal * tension);
        const caidaTensionRealPorcentaje = (caidaTensionReal / tension) * 100;
        solucion += `        - Verificaci√≥n: ŒîU real = ${caidaTensionReal.toFixed(2)} V = ${caidaTensionRealPorcentaje.toFixed(3)}% ${caidaTensionRealPorcentaje <= MAX_CAIDA_TENSION_LGA ? '‚â§' : '>'} ${MAX_CAIDA_TENSION_LGA}% ‚Üí ${caidaTensionRealPorcentaje <= MAX_CAIDA_TENSION_LGA ? 'CUMPLE' : 'NO CUMPLE'}`;
        
        // Actualizar el resultado con la nueva soluci√≥n, enunciado y propiedades adicionales
        result.enunciado = enunciado;
        result.solucion = solucion;
        result.cgpInfo = { 
            intensidad: intensidadCalculada.toFixed(2),
            calibre: calibreCGPSeleccionado,
            potenciaW: PT,
            tension: 400,
            cosfi: factorPotenciaRedondeado
        };
        result.fusibleInfo = { fusible: fusibleSeleccionado };
        result.conductorInfo = conductorInfo;
        result.factorPotencia = factorPotenciaRedondeado;
        result.longitudLGA = longitudLGA;
        // Tablas eliminadas para el bloque 3
    }
    
    return result;
}

// ================================================================
// SISTEMA DE EJERCICIOS GUIADOS
// ================================================================

let guidedExerciseState = {
    currentExercise: null,
    currentStep: 0,
    attempts: 0,
    maxAttempts: 2,
    steps: []
};

function startGuidedExercise() {
    exerciseTitle.textContent = `Bloque ${appState.currentBlock}: Ejercicio Guiado`;
    contentArea.innerHTML = '';
    controlsArea.innerHTML = '';
    
    // Generar un nuevo ejercicio
    const exercise = generateExercise(appState.currentBlock);
    guidedExerciseState.currentExercise = exercise;
    guidedExerciseState.currentStep = 0;
    guidedExerciseState.attempts = 0;
    
    // Definir pasos seg√∫n el bloque
    if (appState.currentBlock === 1) {
        guidedExerciseState.steps = createStepsBlock1(exercise);
    } else if (appState.currentBlock === 2) {
        guidedExerciseState.steps = createStepsBlock2(exercise);
    } else {
        guidedExerciseState.steps = createStepsBlock3(exercise);
    }
    
    displayGuidedExercise();
}

function createStepsBlock1(exercise) {
    // Para ejercicios simples del bloque 1
    // Extraer pasos de la soluci√≥n real
    const steps = [];
    const solucion = exercise.solucion;
    
    // El bloque 1 generalmente tiene solo un paso final
    steps.push({
        question: "¬øCu√°l es la potencia total calculada para esta instalaci√≥n?",
        answer: exercise.resultado,
        unit: "W",
        explanation: "Calcula seg√∫n el tipo de instalaci√≥n y los datos del enunciado."
    });
    
    return steps;
}

function createStepsBlock2(exercise) {
    // Para edificios completos del bloque 2
    const steps = [];
    const solucion = exercise.solucion;
    
    // Extraer valores reales de la soluci√≥n
    try {
        // Buscar PH (Potencia de Viviendas)
        const phMatch = solucion.match(/PH = [\d,.]+ \* [\d,.]+ = ([\d,.]+) W/);
        if (phMatch) {
            const phValue = parseFloat(phMatch[1].replace(',', '.'));
            steps.push({
                question: "1. ¬øCu√°l es la carga de viviendas (PH)?",
                answer: phValue,
                unit: "W",
                explanation: "PH = Potencia media √ó Coeficiente de simultaneidad"
            });
        }
        
        // Buscar PSG (Servicios Generales)
        const psgMatch = solucion.match(/PSG = [\d,.]+ \+ [\d,.]+ \+ [\d,.]+ \+ [\d,.]+ = ([\d,.]+) W/);
        if (psgMatch) {
            const psgValue = parseFloat(psgMatch[1].replace(',', '.'));
            steps.push({
                question: "2. ¬øCu√°l es la carga de servicios generales (PSG)?",
                answer: psgValue,
                unit: "W",
                explanation: "PSG = Ascensores + Alumbrado + Grupo presi√≥n + Auxiliares"
            });
        }
        
        // Buscar PLC (Locales Comerciales)
        const plcMatch = solucion.match(/PLC total = ([\d,.]+) W/);
        if (plcMatch) {
            const plcValue = parseFloat(plcMatch[1].replace(',', '.'));
            steps.push({
                question: "3. ¬øCu√°l es la carga de locales comerciales (PLC)?",
                answer: plcValue,
                unit: "W",
                explanation: "PLC = Suma de todas las cargas de locales comerciales"
            });
        }
        
        // Buscar PG (Garaje)
        const pgMatch = solucion.match(/PG = max\([\d,.]+, [\d,.]+\) = ([\d,.]+) W/);
        if (pgMatch) {
            const pgValue = parseFloat(pgMatch[1].replace(',', '.'));
            steps.push({
                question: "4. ¬øCu√°l es la carga del garaje (PG)?",
                answer: pgValue,
                unit: "W",
                explanation: "PG = max(carga por superficie, m√≠nimo normativo)"
            });
        }
        
        // Buscar PVE (Veh√≠culo El√©ctrico)
        const pveMatch = solucion.match(/PVE = [\d,.]+ \* [\d,.]+ plazas \* [\d,.]+ = ([\d,.]+) W/);
        if (pveMatch) {
            const pveValue = parseFloat(pveMatch[1].replace(',', '.'));
            steps.push({
                question: "5. ¬øCu√°l es la carga de veh√≠culo el√©ctrico (PVE)?",
                answer: pveValue,
                unit: "W",
                explanation: "PVE = Potencia unitaria √ó N¬∫ plazas √ó Factor simultaneidad"
            });
        }
        
        // Paso final: Potencia total
        steps.push({
            question: "6. ¬øCu√°l es la potencia total del edificio (PT)?",
            answer: exercise.resultado,
            unit: "W",
            explanation: "PT = PH + PSG + PLC + PG + PVE"
        });
        
    } catch (error) {
        // Si hay error en la extracci√≥n, usar paso simplificado
        steps.push({
            question: "¬øCu√°l es la potencia total del edificio (PT)?",
            answer: exercise.resultado,
            unit: "W",
            explanation: "PT = PH + PSG + PLC + PG + PVE"
        });
    }
    
    return steps;
}

function createStepsBlock3(exercise) {
    // Para edificios con LGA del bloque 3
    const steps = [];
    const solucion = exercise.solucion;
    
    try {
        // Paso 1: PH (Potencia de Viviendas)
        const phMatch = solucion.match(/PH = [\d,.]+ \* [\d,.]+ = ([\d,.]+) W/);
        if (phMatch) {
            const phValue = parseFloat(phMatch[1].replace(',', '.'));
            steps.push({
                question: "1. ¬øCu√°l es la carga de viviendas (PH)?",
                answer: phValue,
                unit: "W",
                explanation: "PH = Potencia media √ó Coeficiente de simultaneidad"
            });
        }
        
        // Paso 2: PSG (Servicios Generales)
        const psgMatch = solucion.match(/PSG = [\d,.]+ \+ [\d,.]+ \+ [\d,.]+ \+ [\d,.]+ = ([\d,.]+) W/);
        if (psgMatch) {
            const psgValue = parseFloat(psgMatch[1].replace(',', '.'));
            steps.push({
                question: "2. ¬øCu√°l es la carga de servicios generales (PSG)?",
                answer: psgValue,
                unit: "W",
                explanation: "PSG = Ascensores + Alumbrado + Grupo presi√≥n + Auxiliares"
            });
        }
        
        // Paso 3: PLC (Locales Comerciales)
        const plcMatch = solucion.match(/PLC total = ([\d,.]+) W/);
        if (plcMatch) {
            const plcValue = parseFloat(plcMatch[1].replace(',', '.'));
            steps.push({
                question: "3. ¬øCu√°l es la carga de locales comerciales (PLC)?",
                answer: plcValue,
                unit: "W",
                explanation: "PLC = Suma de todas las cargas de locales comerciales"
            });
        }
        
        // Paso 4: PG (Garaje)
        const pgMatch = solucion.match(/PG = max\([\d,.]+, [\d,.]+\) = ([\d,.]+) W/);
        if (pgMatch) {
            const pgValue = parseFloat(pgMatch[1].replace(',', '.'));
            steps.push({
                question: "4. ¬øCu√°l es la carga del garaje (PG)?",
                answer: pgValue,
                unit: "W",
                explanation: "PG = max(carga por superficie, m√≠nimo normativo)"
            });
        }
        
        // Paso 5: PVE (Veh√≠culo El√©ctrico)
        const pveMatch = solucion.match(/PVE = [\d,.]+ \* [\d,.]+ plazas \* [\d,.]+ = ([\d,.]+) W/);
        if (pveMatch) {
            const pveValue = parseFloat(pveMatch[1].replace(',', '.'));
            steps.push({
                question: "5. ¬øCu√°l es la carga de veh√≠culo el√©ctrico (PVE)?",
                answer: pveValue,
                unit: "W",
                explanation: "PVE = Potencia unitaria √ó N¬∫ plazas √ó Factor simultaneidad"
            });
        }
        
        // Paso 6: PT (Potencia Total)
        steps.push({
            question: "6. ¬øCu√°l es la potencia total del edificio (PT)?",
            answer: exercise.resultado,
            unit: "W",
            explanation: "PT = PH + PSG + PLC + PG + PVE"
        });
        
        // Paso 7: Intensidad calculada
        const intensidadMatch = solucion.match(/Intensidad calculada:.*?= ([\d,.]+) A/);
        if (intensidadMatch) {
            const intensidadValue = parseFloat(intensidadMatch[1].replace(',', '.'));
            steps.push({
                question: "7. ¬øCu√°l es la intensidad calculada?",
                answer: intensidadValue,
                unit: "A",
                explanation: "I = P / (‚àö3 √ó U √ó cos œÜ)"
            });
        }
        
        // Paso 8: Fusible CGP seleccionado
        const fusibleMatch = solucion.match(/Fusible CGP seleccionado: ([\d,]+) A/);
        if (fusibleMatch) {
            const fusibleValue = parseFloat(fusibleMatch[1]);
            steps.push({
                question: "8. ¬øCu√°l es el calibre del fusible CGP seleccionado?",
                answer: fusibleValue,
                unit: "A",
                explanation: "Primer fusible normalizado ‚â• 110% de la intensidad calculada"
            });
        }
        
        // Paso 9: Calibre CGP seleccionado
        const calibreCGPMatch = solucion.match(/Calibre CGP seleccionado: ([\d,]+) A/);
        if (calibreCGPMatch) {
            const calibreCGPValue = parseFloat(calibreCGPMatch[1]);
            steps.push({
                question: "9. ¬øCu√°l es el calibre CGP seleccionado?",
                answer: calibreCGPValue,
                unit: "A",
                explanation: "Primer calibre normalizado ‚â• fusible CGP seleccionado"
            });
        }
        
        // Paso 10.1: Secci√≥n por intensidad
        const seccionIntensidadMatch = solucion.match(/Secci√≥n por intensidad.*?: ([\d,]+) mm¬≤/);
        if (seccionIntensidadMatch) {
            const seccionIntValue = parseFloat(seccionIntensidadMatch[1]);
            steps.push({
                question: "10.1. ¬øCu√°l es la secci√≥n del conductor por intensidad?",
                answer: seccionIntValue,
                unit: "mm¬≤",
                explanation: "Seg√∫n tabla AMPACIDAD_ITC_BT_19 para el fusible seleccionado"
            });
        }
        
        // Paso 10.2: Secci√≥n normalizada por ca√≠da de tensi√≥n
        const seccionCaidaMatch = solucion.match(/Primera secci√≥n normalizada ‚â• [\d,.]+ mm¬≤: ([\d,]+) mm¬≤/);
        if (seccionCaidaMatch) {
            const seccionCaidaValue = parseFloat(seccionCaidaMatch[1]);
            steps.push({
                question: "10.2. ¬øCu√°l es la secci√≥n normalizada por ca√≠da de tensi√≥n?",
                answer: seccionCaidaValue,
                unit: "mm¬≤",
                explanation: "Primera secci√≥n de la tabla ‚â• secci√≥n calculada por ca√≠da de tensi√≥n"
            });
        }
        
        // Paso 10.3: Secci√≥n final adoptada
        const seccionFinalMatch = solucion.match(/Secci√≥n adoptada \(la mayor\): ([\d,]+) mm¬≤/);
        if (seccionFinalMatch) {
            const seccionFinalValue = parseFloat(seccionFinalMatch[1]);
            steps.push({
                question: "10.3. ¬øCu√°l es la secci√≥n final adoptada para la LGA?",
                answer: seccionFinalValue,
                unit: "mm¬≤",
                explanation: "La mayor entre la secci√≥n por intensidad y por ca√≠da de tensi√≥n"
            });
        }
        
    } catch (error) {
        // Si hay error en la extracci√≥n, usar pasos simplificados
        steps.push({
            question: "¬øCu√°l es la potencia total del edificio (PT)?",
            answer: exercise.resultado,
            unit: "W",
            explanation: "PT = PH + PSG + PLC + PG + PVE"
        });
        
        if (exercise.cgpInfo && exercise.cgpInfo.intensidad) {
            steps.push({
                question: "¬øCu√°l es la intensidad calculada?",
                answer: parseFloat(exercise.cgpInfo.intensidad),
                unit: "A",
                explanation: "I = P / (‚àö3 √ó U √ó cos œÜ)"
            });
        }
        
        if (exercise.fusibleInfo && exercise.fusibleInfo.fusible) {
            steps.push({
                question: "¬øCu√°l es el calibre del fusible CGP seleccionado?",
                answer: exercise.fusibleInfo.fusible,
                unit: "A",
                explanation: "Primer fusible normalizado ‚â• 110% de la intensidad calculada"
            });
        }
        
        if (exercise.cgpInfo && exercise.cgpInfo.calibre) {
            steps.push({
                question: "¬øCu√°l es el calibre CGP seleccionado?",
                answer: exercise.cgpInfo.calibre,
                unit: "A",
                explanation: "Primer calibre normalizado ‚â• fusible CGP seleccionado"
            });
        }
    }
    
    return steps;
}

function displayGuidedExercise() {
    const currentStep = guidedExerciseState.steps[guidedExerciseState.currentStep];
    
    let html = `
        <div class="guided-exercise">
            <h3>Enunciado del Ejercicio</h3>
            <div class="enunciado">${guidedExerciseState.currentExercise.enunciado}</div>
    `;
    
    // Mostrar pasos completados
    for (let i = 0; i < guidedExerciseState.currentStep; i++) {
        const step = guidedExerciseState.steps[i];
        html += `
            <div class="guided-step completed">
                <div class="step-question">
                    Paso ${i + 1} de ${guidedExerciseState.steps.length}: ${step.question}
                </div>
                <div class="step-feedback step-success">
                    <strong>‚úì Completado:</strong> ${step.answer} ${step.unit}
                    <br><small>${step.explanation}</small>
                </div>
            </div>
        `;
    }
    
    // Mostrar paso actual
    if (guidedExerciseState.currentStep < guidedExerciseState.steps.length) {
        html += `
            <div class="guided-step">
                <div class="step-question">
                    Paso ${guidedExerciseState.currentStep + 1} de ${guidedExerciseState.steps.length}:
                    ${currentStep.question}
                </div>
                
                <div class="step-input">
                    <input type="number" id="stepAnswer" placeholder="Tu respuesta" step="any">
                    <span>${currentStep.unit}</span>
                    <button class="btn" onclick="checkStepAnswer()">Verificar</button>
                </div>
                
                <div id="stepFeedback" class="step-feedback" style="display: none;"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <small>Intentos: ${guidedExerciseState.attempts}/${guidedExerciseState.maxAttempts}</small>
            </div>
        `;
    }
    
    html += `</div>`;
    
    contentArea.innerHTML = html;
    
    // Bot√≥n para volver a ejemplos
    controlsArea.innerHTML = '';
    const backBtn = document.createElement('button');
    backBtn.className = 'btn btn-secondary';
    backBtn.textContent = '‚Üê Volver a Ejemplos';
    backBtn.onclick = displayExamples;
    controlsArea.appendChild(backBtn);
    controlsArea.classList.remove('hidden');
    
    // Focus en el input si hay paso actual
    if (guidedExerciseState.currentStep < guidedExerciseState.steps.length) {
        setTimeout(() => {
            const input = document.getElementById('stepAnswer');
            if (input) input.focus();
        }, 100);
    }
}

function checkStepAnswer() {
    const userAnswer = parseFloat(document.getElementById('stepAnswer').value);
    const correctAnswer = guidedExerciseState.steps[guidedExerciseState.currentStep].answer;
    const feedback = document.getElementById('stepFeedback');
    const tolerance = Math.abs(correctAnswer * 0.02); // Tolerancia del 2%
    
    feedback.style.display = 'block';
    
    if (Math.abs(userAnswer - correctAnswer) <= tolerance) {
        // Respuesta correcta
        feedback.className = 'step-feedback step-success';
        feedback.innerHTML = `
            <strong>¬°Correcto!</strong> La respuesta es ${correctAnswer}.
            <br><small>${guidedExerciseState.steps[guidedExerciseState.currentStep].explanation}</small>
        `;
        
        setTimeout(() => {
            nextStep();
        }, 2000);
        
    } else {
        // Respuesta incorrecta
        guidedExerciseState.attempts++;
        
        if (guidedExerciseState.attempts >= guidedExerciseState.maxAttempts) {
            // Mostrar respuesta correcta y continuar
            feedback.className = 'step-feedback step-hint';
            feedback.innerHTML = `
                <strong>Respuesta correcta:</strong> ${correctAnswer}
                <br><small>${guidedExerciseState.steps[guidedExerciseState.currentStep].explanation}</small>
                <br><em>Continuemos con el siguiente paso usando este valor correcto.</em>
            `;
            
            setTimeout(() => {
                nextStep();
            }, 3000);
            
        } else {
            // Permitir otro intento
            feedback.className = 'step-feedback step-error';
            feedback.innerHTML = `
                <strong>Incorrecto.</strong> Int√©ntalo de nuevo.
                <br><small>Tienes ${guidedExerciseState.maxAttempts - guidedExerciseState.attempts} intento(s) m√°s.</small>
            `;
            
            // Limpiar el input
            document.getElementById('stepAnswer').value = '';
            document.getElementById('stepAnswer').focus();
        }
    }
}

function nextStep() {
    guidedExerciseState.currentStep++;
    guidedExerciseState.attempts = 0;
    
    if (guidedExerciseState.currentStep >= guidedExerciseState.steps.length) {
        // Ejercicio completado
        showCompletionMessage();
    } else {
        // Mostrar siguiente paso
        displayGuidedExercise();
    }
}

function showCompletionMessage() {
    let html = `
        <div class="guided-exercise">
            <h3>Enunciado del Ejercicio</h3>
            <div class="enunciado">${guidedExerciseState.currentExercise.enunciado}</div>
    `;
    
    // Mostrar todos los pasos completados
    for (let i = 0; i < guidedExerciseState.steps.length; i++) {
        const step = guidedExerciseState.steps[i];
        html += `
            <div class="guided-step completed">
                <div class="step-question">
                    Paso ${i + 1} de ${guidedExerciseState.steps.length}: ${step.question}
                </div>
                <div class="step-feedback step-success">
                    <strong>‚úì Completado:</strong> ${step.answer} ${step.unit}
                    <br><small>${step.explanation}</small>
                </div>
            </div>
        `;
    }
    
    // Mensaje de completaci√≥n
    html += `
            <div class="step-feedback step-success" style="margin-top: 20px; font-size: 1.1em;">
                <strong>¬°Felicitaciones!</strong> Has completado el ejercicio guiado exitosamente.
                <br><br>
                Puedes revisar todos los pasos arriba o comenzar un nuevo ejercicio.
            </div>
        </div>
    `;
    
    contentArea.innerHTML = html;
    // Botones para continuar
    controlsArea.innerHTML = '';
    
    const newExerciseBtn = document.createElement('button');
    newExerciseBtn.className = 'btn btn-guided';
    newExerciseBtn.textContent = 'Nuevo Ejercicio Guiado';
    newExerciseBtn.onclick = startGuidedExercise;
    
    const backBtn = document.createElement('button');
    backBtn.className = 'btn btn-secondary';
    backBtn.textContent = '‚Üê Volver a Ejemplos';
    backBtn.onclick = displayExamples;
    backBtn.style.marginLeft = '10px';
    
    controlsArea.appendChild(newExerciseBtn);
    controlsArea.appendChild(backBtn);
}

</script>

</body>

</html>
